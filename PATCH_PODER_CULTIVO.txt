â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PARCHES PARA CORREGIR EL FORMULARIO DE PODER DE CULTIVO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. ELIMINAR ID DUPLICADO (LÃ­nea ~160)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

BUSCAR:
    <input type="hidden" id="poderFinalidad" name="finalidad" value="medicinal" required>

REEMPLAZAR CON:
    <input type="hidden" name="finalidad" value="medicinal" required>

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

2. REEMPLAZAR FUNCIÃ“N setupPoderSignatureCanvas (LÃ­neas 811-876)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

BUSCAR desde la lÃ­nea 811 hasta la lÃ­nea 876:
function setupPoderSignatureCanvas(id) {
    const canvas = document.getElementById(id);
    if (!canvas) return;
    ... (todo el bloque hasta la lÃ­nea 876)
}

REEMPLAZAR CON:
function setupPoderSignatureCanvas(id) {
    console.log(`ğŸ”§ Inicializando canvas ${id}...`);
    const canvas = document.getElementById(id);
    if (!canvas) {
        console.error(`âŒ Canvas ${id} no encontrado en el DOM`);
        return;
    }
    
    console.log(`âœ… Canvas ${id} encontrado:`, canvas);
    console.log(`ğŸ“ Dimensiones del canvas: ${canvas.clientWidth}x${canvas.clientHeight}`);
    
    const ctx = canvas.getContext('2d');
    if (!ctx) {
        console.error(`âŒ No se pudo obtener el contexto 2D para ${id}`);
        return;
    }
    
    let drawing = false;
    let prev = null;
    
    // Ajuste de tamaÃ±o para alta densidad
    function resize() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const rect = canvas.getBoundingClientRect();
        const w = rect.width || canvas.clientWidth || 300;
        const h = rect.height || canvas.clientHeight || 220;
        
        console.log(`ğŸ“ Resize canvas ${id}: ${w}x${h} (ratio: ${ratio})`);
        
        canvas.width = w * ratio;
        canvas.height = h * ratio;
        ctx.scale(ratio, ratio);
        ctx.lineWidth = 2;
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#0f172a';
        ctx.fillStyle = '#0f172a';
    }
    
    resize();
    if (window.ResizeObserver) {
        new ResizeObserver(() => {
            console.log(`ğŸ”„ ResizeObserver detectado para ${id}`);
            resize();
        }).observe(canvas);
    }

    function pos(e) {
        const r = canvas.getBoundingClientRect();
        if (e.touches && e.touches.length) {
            return { 
                x: e.touches[0].clientX - r.left, 
                y: e.touches[0].clientY - r.top 
            };
        } else {
            return { 
                x: e.clientX - r.left, 
                y: e.clientY - r.top 
            };
        }
    }

    function start(e) {
        console.log(`ğŸ–±ï¸ Start drawing en ${id}`);
        drawing = true;
        prev = pos(e);
        // Dibujar un punto inicial para asegurar que se vea algo
        ctx.beginPath();
        ctx.arc(prev.x, prev.y, 1, 0, 2 * Math.PI);
        ctx.fill();
        e.preventDefault();
        e.stopPropagation();
    }
    
    function move(e) {
        if (!drawing) return;
        const p = pos(e);
        ctx.beginPath();
        ctx.moveTo(prev.x, prev.y);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        prev = p;
        e.preventDefault();
        e.stopPropagation();
    }
    
    function end(e) {
        if (drawing) {
            console.log(`ğŸ–±ï¸ End drawing en ${id}`);
            drawing = false;
            prev = null;
        }
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }
    }

    // Asegurar que el canvas sea completamente interactivo
    canvas.style.cursor = 'crosshair';
    canvas.style.touchAction = 'none';
    canvas.style.pointerEvents = 'auto';
    canvas.style.userSelect = 'none';
    canvas.style.webkitUserSelect = 'none';
    canvas.style.msUserSelect = 'none';
    
    // Agregar todos los event listeners necesarios
    canvas.addEventListener('mousedown', start, { passive: false });
    canvas.addEventListener('mousemove', move, { passive: false });
    canvas.addEventListener('mouseup', end, { passive: false });
    canvas.addEventListener('mouseleave', end, { passive: false });
    canvas.addEventListener('mouseout', end, { passive: false });
    
    canvas.addEventListener('touchstart', start, { passive: false });
    canvas.addEventListener('touchmove', move, { passive: false });
    canvas.addEventListener('touchend', end, { passive: false });
    canvas.addEventListener('touchcancel', end, { passive: false });
    
    console.log(`âœ… Canvas de firma ${id} inicializado correctamente con ${canvas.width}x${canvas.height} pÃ­xeles`);
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

3. ACTUALIZAR initPoderCultivoCanvas (LÃ­neas 714-720)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

BUSCAR:
// Inicializar canvas de firmas
function initPoderCultivoCanvas() {
    if (poderCultivoCanvasInitialized) return;
    
    setupPoderSignatureCanvas('sigCedentePoder');
    setupPoderSignatureCanvas('sigCesionarioPoder');
    poderCultivoCanvasInitialized = true;

REEMPLAZAR CON:
// Inicializar canvas de firmas
function initPoderCultivoCanvas() {
    console.log('ğŸ¨ initPoderCultivoCanvas llamado');
    if (poderCultivoCanvasInitialized) {
        console.log('âš ï¸ Canvas ya inicializado, reinicializando...');
        poderCultivoCanvasInitialized = false;
    }
    
    // Solo inicializar el canvas del cedente (el usuario firma)
    const cedenteCanvas = document.getElementById('sigCedentePoder');
    if (cedenteCanvas) {
        console.log('âœ… Canvas sigCedentePoder encontrado en el DOM');
        setTimeout(() => {
            console.log('â±ï¸ Inicializando canvas despuÃ©s de timeout...');
            setupPoderSignatureCanvas('sigCedentePoder');
        }, 300);
    } else {
        console.warn('âš ï¸ Canvas sigCedentePoder no encontrado, intentando de nuevo...');
        setTimeout(() => {
            const canvas = document.getElementById('sigCedentePoder');
            if (canvas) {
                console.log('âœ… Canvas encontrado en segundo intento');
                setupPoderSignatureCanvas('sigCedentePoder');
            } else {
                console.error('âŒ Canvas sigCedentePoder no encontrado despuÃ©s de reintento');
            }
        }, 500);
    }
    
    // La firma del cesionario es fija (imagen del dispensario)
    // No necesita canvas
    
    poderCultivoCanvasInitialized = true;

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

4. ACTUALIZAR CSS DEL CANVAS (LÃ­neas 592-603)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

BUSCAR:
.poder-cultivo-sig-wrap canvas {
    width: 100%;
    height: 220px;
    border-radius: var(--border-radius);
    background: var(--white);
    border: 2px solid var(--light-gray);
    cursor: crosshair;
    transition: var(--transition);
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    position: relative;
    z-index: 1;
}

REEMPLAZAR CON:
.poder-cultivo-sig-wrap canvas {
    width: 100% !important;
    height: 220px !important;
    min-height: 220px !important;
    border-radius: var(--border-radius);
    background: var(--white) !important;
    border: 2px solid var(--light-gray);
    cursor: crosshair !important;
    transition: var(--transition);
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    position: relative;
    z-index: 1;
    pointer-events: auto !important;
    touch-action: none !important;
    user-select: none !important;
    -webkit-user-select: none !important;
    -ms-user-select: none !important;
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

INSTRUCCIONES:
1. Abre frontend/components/poder-cultivo-form.html
2. Aplica cada cambio usando buscar/reemplazar (Ctrl+H)
3. Guarda el archivo
4. Recarga la pÃ¡gina en el navegador
5. Abre la consola (F12) y ve al paso 2 del registro
6. DeberÃ­as ver logs como:
   - ğŸ¨ initPoderCultivoCanvas llamado
   - ğŸ”§ Inicializando canvas sigCedentePoder...
   - ğŸ–±ï¸ Start drawing (cuando hagas clic)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•







