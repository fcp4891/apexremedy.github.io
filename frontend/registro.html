<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/png" href="./assets/images/logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro - Apexremedy</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="./style/css_home.css">
    <link rel="stylesheet" href="./style/registro.css">
        <!-- env-config.js DEBE cargarse PRIMERO para sistema centralizado de rutas -->
    <script src="./js/env-config.js"></script>
<script src="./js/basePath.js"></script>
    <script src="./js/config.js"></script>
    <script src="./js/utils.js"></script>
    <script defer src="./js/template.js"></script>
    <!-- SignaturePad para firmas electr√≥nicas -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
</head>
<body class="register-page">
    <!-- Header template -->
    <div id="header-container"></div>

    <!-- Formulario de Registro -->
    <div class="register-container app-section">
        <div class="container u-container register-form-wrapper">
            <!-- Header -->
            <div class="register-header">
                <div class="register-icon-container">
                    <i class="fas fa-user-plus"></i>
                </div>
                <h2>Crear Cuenta</h2>
                <p>√önete a la comunidad de Apexremedy</p>
            </div>

            <!-- Formulario Multi-Step -->
            <div class="about-card app-card register-form-card">
                <!-- Progress Steps -->
                <div class="steps-container">
                    <div class="steps-progress-line"></div>
                    <div id="progressBar" class="progress-bar"></div>
                    
                    <div class="step-indicator active" data-step="1">
                        <div class="step-circle">1</div>
                        <p>Informaci√≥n Personal</p>
                    </div>
                    
                    <div class="step-indicator" data-step="2">
                        <div class="step-circle">2</div>
                        <p>Documentos</p>
                    </div>
                </div>

                <form id="registerForm">
                    <!-- STEP 1: Informaci√≥n Personal -->
                    <div id="step1" class="form-step">
                        <h3>
                            <i class="fas fa-user-circle"></i> Informaci√≥n Personal
                        </h3>

                        <div class="form-grid">
                            <!-- Nombre -->
                            <div>
                                <label class="form-label">
                                    Nombre Completo *
                                </label>
                                <div class="input-with-icon">
                                    <i class="fas fa-user"></i>
                                    <input type="text" 
                                           id="name" 
                                           name="name"
                                           required
                                           minlength="3"
                                           placeholder="Juan P√©rez">
                                </div>
                            </div>

                            <!-- Email -->
                            <div>
                                <label class="form-label">
                                    Correo Electr√≥nico *
                                </label>
                                <div class="input-with-icon">
                                    <i class="fas fa-envelope"></i>
                                    <input type="email" 
                                           id="email" 
                                           name="email"
                                           required
                                           placeholder="tu@email.com">
                                </div>
                            </div>

                            <!-- Tel√©fono y RUT -->
                            <div class="form-grid-2">
                                <div>
                                    <label class="form-label">
                                        Tel√©fono *
                                    </label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-phone"></i>
                                        <input type="tel" 
                                               id="phone" 
                                               name="phone"
                                               required
                                               placeholder="+56912345678">
                                    </div>
                                </div>

                                <div>
                                    <label class="form-label">
                                        RUT *
                                    </label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-id-card"></i>
                                        <input type="text" 
                                               id="rut" 
                                               name="rut"
                                               required
                                               placeholder="12.345.678-9">
                                    </div>
                                    <p id="rutError" style="display: none; color: #ef4444; font-size: 0.875rem; margin-top: 4px;">
                                        <i class="fas fa-exclamation-circle"></i> <span id="rutErrorText">RUT inv√°lido</span>
                                    </p>
                                </div>
                            </div>

                            <!-- Direcci√≥n (Opcional) -->
                            <div id="addressSection">
                                <label class="form-label">
                                    <i class="fas fa-map-marker-alt"></i> Direcci√≥n de Entrega (Opcional)
                                </label>
                                <p class="password-hint" style="margin-bottom: 8px;">
                                    Puedes agregarla ahora o m√°s tarde en el proceso de compra
                                </p>
                                <div class="input-with-icon">
                                    <i class="fas fa-home"></i>
                                    <input type="text" 
                                           id="addressLine1" 
                                           name="addressLine1"
                                           placeholder="Calle y n√∫mero">
                                </div>
                                <!-- Tipo de direcci√≥n (Depto/Casa/Oficina) -->
                                <div class="input-with-icon" style="margin-top: 8px; position: relative;">
                                    <i class="fas fa-building" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); z-index: 1;"></i>
                                    <select id="addressType" 
                                            name="addressType"
                                            style="width: 100%; padding: 12px 12px 12px 40px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; appearance: none; background-color: white; cursor: pointer;">
                                        <option value="">Tipo (opcional)</option>
                                        <option value="Depto">Depto</option>
                                        <option value="Casa">Casa</option>
                                        <option value="Oficina">Oficina</option>
                                    </select>
                                    <i class="fas fa-chevron-down" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; color: #9ca3af;"></i>
                                </div>
                                
                                <!-- Referencia (texto aparte) -->
                                <div class="input-with-icon" style="margin-top: 8px;">
                                    <i class="fas fa-info-circle"></i>
                                    <input type="text" 
                                           id="addressReference" 
                                           name="addressReference"
                                           placeholder="Referencia (opcional)">
                                </div>
                                
                                <!-- Regi√≥n (Combobox) -->
                                <div class="input-with-icon" style="margin-top: 8px; position: relative;">
                                    <i class="fas fa-globe-americas" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); z-index: 1;"></i>
                                    <select id="region" 
                                            name="region"
                                            onchange="loadCitiesForRegion()"
                                            style="width: 100%; padding: 12px 12px 12px 40px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; appearance: none; background-color: white; cursor: pointer;">
                                        <option value="">Selecciona una regi√≥n</option>
                                    </select>
                                    <i class="fas fa-chevron-down" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; color: #9ca3af;"></i>
                                </div>
                                
                                <!-- Ciudad (Combobox) -->
                                <div class="input-with-icon" style="margin-top: 8px; position: relative;">
                                    <i class="fas fa-city" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); z-index: 1;"></i>
                                    <select id="city" 
                                            name="city"
                                            onchange="loadCommunesForCity()"
                                            disabled
                                            style="width: 100%; padding: 12px 12px 12px 40px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; appearance: none; background-color: #f5f5f5; cursor: not-allowed; color: #999;">
                                        <option value="">Primero selecciona una regi√≥n</option>
                                    </select>
                                    <i class="fas fa-chevron-down" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; color: #9ca3af;"></i>
                                </div>
                                
                                <!-- Comuna (Combobox) -->
                                <div class="input-with-icon" style="margin-top: 8px; position: relative;">
                                    <i class="fas fa-map-pin" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); z-index: 1;"></i>
                                    <select id="commune" 
                                            name="commune"
                                            disabled
                                            style="width: 100%; padding: 12px 12px 12px 40px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; appearance: none; background-color: #f5f5f5; cursor: not-allowed; color: #999;">
                                        <option value="">Primero selecciona una ciudad</option>
                                    </select>
                                    <i class="fas fa-chevron-down" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; color: #9ca3af;"></i>
                                </div>
                            </div>

                            <!-- Fechas de Cesi√≥n de Cultivo -->
                            <div class="form-grid-2" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--light-gray);">
                                <div>
                                    <label class="form-label">
                                        <i class="fas fa-calendar-alt" style="color: var(--primary-green); margin-right: 6px;"></i>
                                        Fecha Inicio de Cesi√≥n *
                                    </label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-calendar-check"></i>
                                        <input type="date" 
                                               id="fechaInicio" 
                                               name="fechaInicio"
                                               required
                                               min="">
                                    </div>
                                    <p class="password-hint" style="font-size: 0.85rem;">
                                        Fecha desde la cual autorizas el cultivo
                                    </p>
                                </div>

                                <div>                                   
                                    <div id="fechaTerminoContainer">
                                        <label class="form-label">
                                            <i class="fas fa-calendar-times" style="color: var(--primary-green); margin-right: 6px;"></i>
                                            Fecha T√©rmino de Cesi√≥n *
                                        </label>
                                        <div class="input-with-icon">
                                            <i class="fas fa-calendar"></i>
                                            <input type="date" 
                                                   id="fechaTermino" 
                                                   name="fechaTermino"
                                                   required
                                                   min="">
                                        </div>
                                        <p class="password-hint" style="font-size: 0.85rem;">
                                            Ingresa la fecha de t√©rmino de la cesi√≥n
                                        </p>
                                    </div>
                                    <div style="margin-bottom: 8px;">
                                        <label class="terms-checkbox-label" style="font-size: 0.95rem; font-weight: 600;">
                                            <input type="checkbox" 
                                                   id="esIndefinido"
                                                   name="esIndefinido">
                                            <span>Indefinido / Revocable</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Contrase√±a -->
                            <div class="form-grid-2" style="margin-top: 20px;">
                                <div>
                                    <label class="form-label">
                                        Contrase√±a *
                                    </label>
                                    <div class="input-with-icon password-input">
                                        <i class="fas fa-lock"></i>
                                        <input type="password" 
                                               id="password" 
                                               name="password"
                                               required
                                               minlength="6"
                                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                        <button type="button" 
                                                id="togglePassword"
                                                class="toggle-password-btn">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <p class="password-hint">
                                        M√≠nimo 6 caracteres
                                    </p>
                                </div>

                                <div>
                                    <label class="form-label">
                                        Confirmar Contrase√±a *
                                    </label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-lock"></i>
                                        <input type="password" 
                                               id="confirmPassword" 
                                               name="confirmPassword"
                                               required
                                               minlength="6"
                                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                    </div>
                                    <p id="passwordMatchError" style="display: none; color: #ef4444; font-size: 0.875rem; margin-top: 4px;">
                                        <i class="fas fa-exclamation-circle"></i> Las contrase√±as no coinciden
                                    </p>
                                    <p id="passwordMatchSuccess" style="display: none; color: #10b981; font-size: 0.875rem; margin-top: 4px;">
                                        <i class="fas fa-check-circle"></i> Las contrase√±as coinciden
                                    </p>
                                </div>
                            </div>

                            <!-- T√©rminos -->
                            <div style="margin-top: 10px;">
                                <label class="terms-checkbox-label">
                                    <input type="checkbox" 
                                           id="terms"
                                           required>
                                    <span>
                                        Acepto los <a href="#">t√©rminos y condiciones</a> y la <a href="#">pol√≠tica de privacidad</a>
                                    </span>
                                </label>
                            </div>
                        </div>

                        <div class="step-buttons">
                            <button type="button" onclick="nextStep()" class="cta-button app-button app-button--primary full-width">
                                Siguiente: Documentos <i class="fas fa-arrow-right" style="margin-left: 8px;"></i>
                            </button>
                        </div>
                    </div>

                    <!-- STEP 2: Documentos -->
                    <div id="step2" class="form-step" style="display: none;">
                        <h3 class="document-section-title">
                            <i class="fas fa-file-medical"></i> Documentaci√≥n Requerida
                        </h3>
                        <p class="document-section-description">
                            Para completar tu registro, necesitamos los siguientes documentos (formato PDF, JPG o PNG, m√°ximo 5MB cada uno)
                        </p>

                        <!-- Documento 1: Receta M√©dica -->
                        <div class="document-upload-area" style="margin-bottom: 24px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 12px; color: var(--accent-black); display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-prescription" style="color: #10b981;"></i> Receta M√©dica *
                            </label>
                            <div class="upload-zone" id="uploadReceta" style="border: 2px dashed var(--light-gray); border-radius: var(--border-radius); padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s; background: var(--white);">
                                <input type="file" id="recetaFile" accept=".pdf,.jpg,.jpeg,.png" class="hidden" onchange="handleDocumentUpload(event, 'receta')">
                                <!-- Contenedor de previsualizaci√≥n -->
                                <div id="recetaImagePreview" style="display: none; margin-bottom: 20px; text-align: center;">
                                    <img id="recetaImagePreviewImg" src="" alt="Vista previa" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--light-gray); box-shadow: 0 2px 8px rgba(0,0,0,0.1); object-fit: contain; display: none;">
                                    <div id="recetaPdfPreview" style="display: none; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid var(--light-gray); max-width: 200px; margin: 0 auto;">
                                        <i class="fas fa-file-pdf" style="font-size: 3rem; color: #dc3545; margin-bottom: 8px; display: block;"></i>
                                        <p id="recetaPdfFileName" style="font-size: 0.85rem; color: var(--medium-gray); margin: 0; word-break: break-word;"></p>
                                    </div>
                                </div>
                                <div id="recetaPlaceholder">
                                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--medium-gray); margin-bottom: 12px; display: block;"></i>
                                    <p style="color: var(--medium-gray); margin-bottom: 8px; font-weight: 600;">Arrastra tu receta m√©dica aqu√≠</p>
                                    <p style="color: var(--medium-gray); font-size: 0.85rem; margin-bottom: 16px;">o haz clic para seleccionar</p>
                                    <button type="button" onclick="document.getElementById('recetaFile').click()" class="secondary-button app-button app-button--secondary">
                                        <i class="fas fa-folder-open" style="margin-right: 8px;"></i>Seleccionar Archivo
                                    </button>
                                </div>
                                <div id="recetaPreview" style="display: none;">
                                    <p id="recetaFileName" style="font-weight: 600; color: var(--primary-green); margin-bottom: 8px;"></p>
                                    <p id="recetaFileSize" style="font-size: 0.85rem; color: var(--medium-gray); margin-bottom: 16px;"></p>
                                    <button type="button" onclick="removeDocument('receta')" class="secondary-button app-button app-button--danger" style="border-color: var(--error); color: var(--error);">
                                        <i class="fas fa-trash" style="margin-right: 8px;"></i>Eliminar
                                    </button>
                                </div>
                            </div>
                            <input type="hidden" id="recetaData">
                        </div>
<!-- Documento 2: Carnet -->
<div class="document-upload-area" style="margin-bottom: 24px;">
    <label style="display: block; font-weight: 600; margin-bottom: 12px; color: var(--accent-black); display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-id-card" style="color: #3b82f6;"></i> Carnet de Identidad *
    </label>
    <div class="upload-zone" id="uploadCarnet" style="border: 2px dashed var(--light-gray); border-radius: var(--border-radius); padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s; background: var(--white);">
        <input type="file" id="carnetFile" accept=".pdf,.jpg,.jpeg,.png" class="hidden" onchange="handleDocumentUpload(event, 'carnet')">
        <!-- Contenedor de previsualizaci√≥n -->
        <div id="carnetImagePreview" style="display: none; margin-bottom: 20px; text-align: center;">
            <img id="carnetImagePreviewImg" src="" alt="Vista previa" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--light-gray); box-shadow: 0 2px 8px rgba(0,0,0,0.1); object-fit: contain; display: none;">
            <div id="carnetPdfPreview" style="display: none; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid var(--light-gray); max-width: 200px; margin: 0 auto;">
                <i class="fas fa-file-pdf" style="font-size: 3rem; color: #dc3545; margin-bottom: 8px; display: block;"></i>
                <p id="carnetPdfFileName" style="font-size: 0.85rem; color: var(--medium-gray); margin: 0; word-break: break-word;"></p>
            </div>
        </div>
        <div id="carnetPlaceholder">
            <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--medium-gray); margin-bottom: 12px; display: block;"></i>
            <p style="color: var(--medium-gray); margin-bottom: 8px; font-weight: 600;">Arrastra tu carnet aqu√≠</p>
            <p style="color: var(--medium-gray); font-size: 0.85rem; margin-bottom: 16px;">o haz clic para seleccionar</p>
            <button type="button" onclick="document.getElementById('carnetFile').click()" class="secondary-button app-button app-button--secondary">
                <i class="fas fa-folder-open" style="margin-right: 8px;"></i>Seleccionar Archivo
            </button>
        </div>
        <div id="carnetPreview" style="display: none;">
            <p id="carnetFileName" style="font-weight: 600; color: var(--primary-green); margin-bottom: 8px;"></p>
            <p id="carnetFileSize" style="font-size: 0.85rem; color: var(--medium-gray); margin-bottom: 16px;"></p>
            <button type="button" onclick="removeDocument('carnet')" class="secondary-button app-button app-button--danger" style="border-color: var(--error); color: var(--error);">
                <i class="fas fa-trash" style="margin-right: 8px;"></i>Eliminar
            </button>
        </div>
    </div>
    <input type="hidden" id="carnetData">
</div>

<!-- Documento 3: Certificado de Antecedentes -->
<div class="document-upload-area" style="margin-bottom: 24px;">
    <label style="display: block; font-weight: 600; margin-bottom: 12px; color: var(--accent-black); display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-certificate" style="color: #8b5cf6;"></i> Certificado de Antecedentes *
    </label>
    <div class="upload-zone" id="uploadCertificado" style="border: 2px dashed var(--light-gray); border-radius: var(--border-radius); padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s; background: var(--white);">
        <input type="file" id="certificadoFile" accept=".pdf,.jpg,.jpeg,.png" class="hidden" onchange="handleDocumentUpload(event, 'certificado')">
        <!-- Contenedor de previsualizaci√≥n -->
        <div id="certificadoImagePreview" style="display: none; margin-bottom: 20px; text-align: center;">
            <img id="certificadoImagePreviewImg" src="" alt="Vista previa" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--light-gray); box-shadow: 0 2px 8px rgba(0,0,0,0.1); object-fit: contain; display: none;">
            <div id="certificadoPdfPreview" style="display: none; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid var(--light-gray); max-width: 200px; margin: 0 auto;">
                <i class="fas fa-file-pdf" style="font-size: 3rem; color: #dc3545; margin-bottom: 8px; display: block;"></i>
                <p id="certificadoPdfFileName" style="font-size: 0.85rem; color: var(--medium-gray); margin: 0; word-break: break-word;"></p>
            </div>
        </div>
        <div id="certificadoPlaceholder">
            <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--medium-gray); margin-bottom: 12px; display: block;"></i>
            <p style="color: var(--medium-gray); margin-bottom: 8px; font-weight: 600;">Arrastra tu certificado aqu√≠</p>
            <p style="color: var(--medium-gray); font-size: 0.85rem; margin-bottom: 16px;">o haz clic para seleccionar</p>
            <button type="button" onclick="document.getElementById('certificadoFile').click()" class="secondary-button app-button app-button--secondary">
                <i class="fas fa-folder-open" style="margin-right: 8px;"></i>Seleccionar Archivo
            </button>
        </div>
        <div id="certificadoPreview" style="display: none;">
            <p id="certificadoFileName" style="font-weight: 600; color: var(--primary-green); margin-bottom: 8px;"></p>
            <p id="certificadoFileSize" style="font-size: 0.85rem; color: var(--medium-gray); margin-bottom: 16px;"></p>
            <button type="button" onclick="removeDocument('certificado')" class="secondary-button app-button app-button--danger" style="border-color: var(--error); color: var(--error);">
                <i class="fas fa-trash" style="margin-right: 8px;"></i>Eliminar
            </button>
        </div>
    </div>
    <input type="hidden" id="certificadoData">
</div>

<!-- Documento 4: Poder de Cultivo (Cesi√≥n) -->
<div class="document-upload-area" style="margin-bottom: 24px;">
    <label style="display: block; font-weight: 600; margin-bottom: 12px; color: var(--accent-black); display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-leaf" style="color: #0f766e;"></i> Poder de Cultivo (Cesi√≥n de Derechos) *
    </label>
    <p style="color: var(--medium-gray); font-size: 0.9rem; margin-bottom: 16px;">
        Debes completar y generar el formulario de cesi√≥n de derechos de cultivo. Este documento es obligatorio seg√∫n la Ley 20.000.
    </p>
    
    <!-- Contenedor para el formulario de poder cultivo -->
    <div id="poderCultivoContainer"></div>
    
    <input type="hidden" id="poderCultivoData">
    <input type="hidden" id="poderCultivoFileName">
    
    <div id="poderCultivoStatus" style="display: none; margin-top: 12px; padding: 12px; background: #ecfdf5; border: 1px solid #10b981; border-radius: 8px;">
        <div style="display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-check-circle" style="color: #10b981;"></i>
            <span style="color: #065f46; font-weight: 600;">Documento de cesi√≥n generado correctamente</span>
        </div>
        <p id="poderCultivoFileNameDisplay" style="color: #047857; font-size: 0.85rem; margin: 8px 0 0 0;"></p>
    </div>
</div>

<div style="margin-top: 32px; display: flex; gap: 12px;">
    <button type="button" onclick="prevStep()" class="secondary-button app-button app-button--secondary" style="flex: 1;">
        <i class="fas fa-arrow-left" style="margin-right: 8px;"></i> Atr√°s
    </button>
    <button type="button" onclick="submitForm()" id="submitBtn" class="cta-button app-button app-button--primary" style="flex: 2;">
        <span id="btnText">Crear Cuenta</span>
        <i id="btnLoader" style="display: none;" class="fas fa-spinner fa-spin" style="margin-left: 8px;"></i>
    </button>
</div>
</div>
</form>

<!-- Login Link -->
<div style="margin-top: 32px; text-align: center; padding-top: 24px; border-top: 1px solid var(--light-gray);">
<p style="color: var(--medium-gray);">
¬øYa tienes cuenta? 
<a href="./login.html" style="color: var(--primary-green); font-weight: 600; text-decoration: none;">
    Inicia Sesi√≥n
</a>
</p>
</div>
</div>
</div>
</div>

<!-- Footer template -->
<div id="footer-container"></div>

<!-- Scripts -->
<script src="./js/api/apiClient.js"></script>
<script src="./js/auth.js"></script>
<script src="./js/notifications.js"></script>
<script src="./js/db_articulos.js"></script>
<script src="./js/carrito.js"></script>

<!-- Cargar componente de poder cultivo -->
<script>
// Cargar el componente de poder cultivo
async function loadPoderCultivoForm() {
    try {
        const response = await fetch('./components/poder-cultivo-form.html');
        if (response.ok) {
            const html = await response.text();
            const container = document.getElementById('poderCultivoContainer');
            if (container) {
                container.innerHTML = html;
                // Ejecutar scripts del componente
                const scripts = container.querySelectorAll('script');
                scripts.forEach(oldScript => {
                    const newScript = document.createElement('script');
                    if (oldScript.src) {
                        newScript.src = oldScript.src;
                    } else {
                        newScript.textContent = oldScript.textContent;
                    }
                    document.body.appendChild(newScript);
                    oldScript.remove();
                });
                // Inicializar el formulario
                if (window.initPoderCultivoForm) {
                    window.initPoderCultivoForm();
                }
            }
        }
    } catch (error) {
        console.error('Error cargando formulario de poder cultivo:', error);
    }
}

// Escuchar evento cuando se genera el documento
document.addEventListener('poderCultivoGenerated', async function(event) {
    const { htmlBase64, fileName, cessionData } = event.detail;
    
    console.log('üìù Evento poderCultivoGenerated recibido:', {
        htmlBase64_length: htmlBase64 ? htmlBase64.length : 0,
        fileName: fileName,
        preview: htmlBase64 ? htmlBase64.substring(0, 100) : 'null'
    });
    
    // Guardar en el input hidden
    const poderCultivoDataInput = document.getElementById('poderCultivoData');
    const poderCultivoFileNameInput = document.getElementById('poderCultivoFileName');
    
    if (poderCultivoDataInput) {
        poderCultivoDataInput.value = htmlBase64;
        console.log('‚úÖ Valor guardado en poderCultivoData:', {
            value_length: poderCultivoDataInput.value ? poderCultivoDataInput.value.length : 0,
            preview: poderCultivoDataInput.value ? poderCultivoDataInput.value.substring(0, 100) : 'null'
        });
    } else {
        console.error('‚ùå No se encontr√≥ el elemento poderCultivoData');
    }
    
    if (poderCultivoFileNameInput) {
        poderCultivoFileNameInput.value = fileName;
    } else {
        console.error('‚ùå No se encontr√≥ el elemento poderCultivoFileName');
    }
    
    // Guardar datos de cesi√≥n en localStorage temporalmente (se guardar√°n en BD al hacer submit)
    if (cessionData) {
        localStorage.setItem('tempCessionData', JSON.stringify(cessionData));
    }
    
    // Mostrar estado
    const statusDiv = document.getElementById('poderCultivoStatus');
    const fileNameDisplay = document.getElementById('poderCultivoFileNameDisplay');
    if (statusDiv) {
        statusDiv.style.display = 'block';
    }
    if (fileNameDisplay) {
        fileNameDisplay.textContent = `Archivo: ${fileName}`;
    }
    
    notify.success('Documento de cesi√≥n generado correctamente');
});

// Cargar cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', () => {
    // Cargar cuando se muestre el step 2
    const observer = new MutationObserver((mutations) => {
        const step2 = document.getElementById('step2');
        if (step2 && step2.style.display !== 'none') {
            loadPoderCultivoForm();
            observer.disconnect();
        }
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['style', 'class']
    });
    
    // Tambi√©n intentar cargar inmediatamente si step2 ya est√° visible
    const step2 = document.getElementById('step2');
    if (step2 && step2.style.display !== 'none') {
        loadPoderCultivoForm();
    }
});
</script>

<script>
// ===========================================
// VARIABLES GLOBALES
// ===========================================

let currentStep = 1;
const totalSteps = 2;

// ===========================================
// NAVEGACI√ìN ENTRE PASOS
// ===========================================

function nextStep() {
    // Validar RUT y correo antes de avanzar (por si se autocompletaron incorrectamente)
    const rutInput = document.getElementById('rut');
    const emailInput = document.getElementById('email');
    
    // Validar RUT si existe y tiene valor
    if (rutInput && rutInput.value.trim() !== '') {
        const rutError = document.getElementById('rutError');
        let cleanRUT = rutInput.value.trim().replace(/\./g, '').replace(/-/g, '').replace(/\s/g, '').toUpperCase();
        
        if (/^\d{7,8}[\dkK]$/.test(cleanRUT)) {
            const body = cleanRUT.slice(0, -1);
            const dv = cleanRUT.slice(-1).toUpperCase();
            if (body.length >= 7 && body.length <= 8) {
                let sum = 0;
                let multiplier = 2;
                for (let i = body.length - 1; i >= 0; i--) {
                    sum += parseInt(body[i]) * multiplier;
                    multiplier = multiplier === 7 ? 2 : multiplier + 1;
                }
                const remainder = sum % 11;
                const calculatedDV = remainder === 0 ? '0' : remainder === 1 ? 'K' : (11 - remainder).toString();
                
                if (dv !== calculatedDV) {
                    notify.error(`El RUT ingresado no es v√°lido. El d√≠gito verificador deber√≠a ser "${calculatedDV}"`);
                    if (rutInput) {
                        rutInput.style.borderColor = '#ef4444';
                        rutInput.focus();
                    }
                    if (rutError) {
                        const errorText = rutError.querySelector('#rutErrorText');
                        if (errorText) {
                            errorText.textContent = `D√≠gito verificador incorrecto. Deber√≠a ser "${calculatedDV}" en lugar de "${dv}"`;
                        }
                        rutError.style.display = 'block';
                    }
                    return false;
                }
            }
        } else {
            // Formato inv√°lido
            notify.error('El RUT ingresado no tiene un formato v√°lido');
            if (rutInput) {
                rutInput.style.borderColor = '#ef4444';
                rutInput.focus();
            }
            return false;
        }
    }
    
    // Validar correo si existe y tiene valor
    if (emailInput && emailInput.value.trim() !== '') {
        const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
        const isValid = emailRegex.test(emailInput.value.trim()) && emailInput.value.length <= 254;
        
        if (!isValid) {
            notify.error('El correo electr√≥nico ingresado no es v√°lido. Por favor, corr√≠gelo antes de continuar.');
            if (emailInput) {
                emailInput.style.borderColor = '#ef4444';
                emailInput.focus();
            }
            return false;
        }
    }
    
    // Si pasa todas las validaciones, ejecutar validateStep1 y avanzar
    if (validateStep1()) {
        currentStep = 2;
        updateStepDisplay();
    }
}

function prevStep() {
    currentStep = 1;
    updateStepDisplay();
}

function updateStepDisplay() {
    // Ocultar todos los steps
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'none';

    // Mostrar step actual
    document.getElementById(`step${currentStep}`).style.display = 'block';

    // Actualizar indicadores
    document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
        const stepNum = index + 1;
        const circle = indicator.querySelector('.step-circle');
        const text = indicator.querySelector('p');

        if (stepNum < currentStep) {
            circle.style.background = '#8d523b';
            circle.style.color = 'white';
            text.style.color = '#8d523b';
        } else if (stepNum === currentStep) {
            circle.style.background = '#8d523b';
            circle.style.color = 'white';
            text.style.color = '#8d523b';
        } else {
            circle.style.background = '#f8f9fa';
            circle.style.color = '#6c757d';
            text.style.color = '#6c757d';
        }
    });

    // Actualizar barra de progreso
    const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
    document.getElementById('progressBar').style.width = progress + '%';

    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ===========================================
// VALIDACI√ìN PASO 1
// ===========================================

function validateStep1() {
    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const rut = document.getElementById('rut').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const fechaInicio = document.getElementById('fechaInicio').value;
    const esIndefinido = document.getElementById('esIndefinido').checked;
    const fechaTermino = document.getElementById('fechaTermino').value;
    const terms = document.getElementById('terms').checked;
    const rutError = document.getElementById('rutError');
    const emailInput = document.getElementById('email');
    const rutInput = document.getElementById('rut');

    // Validar nombre
    if (!name || name.length < 3) {
        notify.error('El nombre debe tener al menos 3 caracteres');
        document.getElementById('name').focus();
        return false;
    }

    // Validar email (obligatorio)
    if (!email) {
        notify.error('Por favor ingresa tu correo electr√≥nico');
        emailInput.style.borderColor = '#ef4444';
        emailInput.focus();
        return false;
    }

    // Validar formato de email
    let emailValid = false;
    if (typeof Utils !== 'undefined' && Utils.isValidEmail) {
        emailValid = Utils.isValidEmail(email);
    } else {
        const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
        emailValid = emailRegex.test(email.trim()) && email.length <= 254;
    }

    if (!emailValid) {
        notify.error('Por favor ingresa un correo electr√≥nico v√°lido');
        emailInput.style.borderColor = '#ef4444';
        emailInput.focus();
        return false;
    } else {
        emailInput.style.borderColor = '#10b981';
    }

    // Validar tel√©fono (obligatorio)
    if (!phone) {
        notify.error('Por favor ingresa tu tel√©fono');
        document.getElementById('phone').style.borderColor = '#ef4444';
        document.getElementById('phone').focus();
        return false;
    } else {
        document.getElementById('phone').style.borderColor = '';
    }

    // Validar RUT (obligatorio)
    if (!rut || rut.trim() === '') {
        notify.error('Por favor ingresa tu RUT');
        if (rutInput) {
            rutInput.style.borderColor = '#ef4444';
            rutInput.focus();
        }
        if (rutError) {
            const errorText = rutError.querySelector('#rutErrorText');
            if (errorText) errorText.textContent = 'Debes ingresar tu RUT';
            rutError.style.display = 'block';
        }
        return false;
    }

    // Validar que el RUT sea v√°lido (validaci√≥n estricta)
    let rutValid = false;
    let rutValidationError = '';
    
    // Limpiar RUT (eliminar puntos, guiones y espacios)
    let cleanRUT = rut.trim().replace(/\./g, '').replace(/-/g, '').replace(/\s/g, '').toUpperCase();
    
    // Verificar formato b√°sico
    if (!/^\d{7,8}[\dkK]$/.test(cleanRUT)) {
        rutValidationError = 'El RUT debe tener 7 u 8 d√≠gitos seguidos de un d√≠gito verificador (ej: 12345678-9)';
    } else {
        const body = cleanRUT.slice(0, -1);
        const dv = cleanRUT.slice(-1).toUpperCase();
        
        if (body.length < 7 || body.length > 8) {
            rutValidationError = 'El RUT debe tener 7 u 8 d√≠gitos en el cuerpo';
        } else {
            // Calcular d√≠gito verificador
            let sum = 0;
            let multiplier = 2;
            for (let i = body.length - 1; i >= 0; i--) {
                sum += parseInt(body[i]) * multiplier;
                multiplier = multiplier === 7 ? 2 : multiplier + 1;
            }
            const remainder = sum % 11;
            const calculatedDV = remainder === 0 ? '0' : remainder === 1 ? 'K' : (11 - remainder).toString();
            
            if (dv !== calculatedDV) {
                rutValidationError = `El d√≠gito verificador es incorrecto. Deber√≠a ser "${calculatedDV}" en lugar de "${dv}"`;
            } else {
                rutValid = true;
            }
        }
    }

    if (!rutValid) {
        notify.error(rutValidationError || 'El RUT ingresado no es v√°lido. Verifica el formato y el d√≠gito verificador.');
        if (rutInput) {
            rutInput.style.borderColor = '#ef4444';
            rutInput.focus();
        }
        if (rutError) {
            const errorText = rutError.querySelector('#rutErrorText');
            if (errorText) errorText.textContent = rutValidationError || 'RUT inv√°lido. Verifica el formato y el d√≠gito verificador.';
            rutError.style.display = 'block';
        }
        return false;
    } else {
        if (rutInput) rutInput.style.borderColor = '#10b981';
        if (rutError) rutError.style.display = 'none';
    }

    // Validar contrase√±a
    if (!password || password.length < 6) {
        notify.error('La contrase√±a debe tener al menos 6 caracteres');
        document.getElementById('password').focus();
        return false;
    }

    // Validar que las contrase√±as coincidan
    if (password !== confirmPassword) {
        notify.error('Las contrase√±as no coinciden');
        document.getElementById('confirmPassword').focus();
        return false;
    }

    // Validar fecha inicio
    if (!fechaInicio) {
        notify.error('Debes ingresar la fecha de inicio de la cesi√≥n');
        document.getElementById('fechaInicio').focus();
        return false;
    }

    // Validar fecha t√©rmino (obligatoria si NO est√° marcado "Indefinido / Revocable")
    if (!esIndefinido) {
        if (!fechaTermino) {
            notify.error('Debes ingresar la fecha de t√©rmino de la cesi√≥n o marcar "Indefinido / Revocable"');
            const fechaTerminoInput = document.getElementById('fechaTermino');
            if (fechaTerminoInput) {
                fechaTerminoInput.style.borderColor = '#ef4444';
                fechaTerminoInput.focus();
            }
            return false;
        }
        
        // Validar que fecha t√©rmino sea mayor o igual a fecha inicio
        if (fechaTermino < fechaInicio) {
            notify.error('La fecha de t√©rmino debe ser mayor o igual a la fecha de inicio');
            const fechaTerminoInput = document.getElementById('fechaTermino');
            if (fechaTerminoInput) {
                fechaTerminoInput.style.borderColor = '#ef4444';
                fechaTerminoInput.focus();
            }
            return false;
        }
    }

    // Validar t√©rminos
    if (!terms) {
        notify.error('Debes aceptar los t√©rminos y condiciones');
        document.getElementById('terms').focus();
        return false;
    }

return true;
}

// ===========================================
// MANEJO DE DOCUMENTOS
// ===========================================

function setupDragAndDrop() {
const zones = ['uploadReceta', 'uploadCarnet', 'uploadCertificado'];

zones.forEach(zoneId => {
const zone = document.getElementById(zoneId);
if (!zone) return;

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
zone.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
e.preventDefault();
e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
zone.addEventListener(eventName, () => {
zone.style.borderColor = '#8d523b';
zone.style.background = 'rgba(141, 82, 59, 0.05)';
}, false);
});

['dragleave', 'drop'].forEach(eventName => {
zone.addEventListener(eventName, () => {
zone.style.borderColor = '#f8f9fa';
zone.style.background = '#fff';
}, false);
});

zone.addEventListener('drop', (e) => {
const docType = zoneId.replace('upload', '').toLowerCase();
const file = e.dataTransfer.files[0];
if (file) {
processDocument(file, docType);
}
}, false);

// Click en zona
zone.addEventListener('click', (e) => {
if (e.target.closest('button')) return;
const docType = zoneId.replace('upload', '').toLowerCase();
document.getElementById(`${docType}File`).click();
});
});
}

function handleDocumentUpload(event, type) {
const file = event.target.files[0];
if (file) {
processDocument(file, type);
}
}

function processDocument(file, type) {
// Validar tipo de archivo
const validTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
if (!validTypes.includes(file.type)) {
notify.error('Formato no v√°lido. Solo se permiten PDF, JPG y PNG');
return;
}

// Validar tama√±o (5MB)
const maxSize = 5 * 1024 * 1024;
if (file.size > maxSize) {
notify.error('El archivo no debe superar 5MB');
return;
}

// Leer archivo como Base64
const reader = new FileReader();
reader.onload = function(e) {
const base64 = e.target.result;

// Guardar en hidden input
document.getElementById(`${type}Data`).value = base64;

// Mostrar previsualizaci√≥n de imagen/PDF
const imagePreview = document.getElementById(`${type}ImagePreview`);
const imagePreviewImg = document.getElementById(`${type}ImagePreviewImg`);
const pdfPreview = document.getElementById(`${type}PdfPreview`);
const pdfFileName = document.getElementById(`${type}PdfFileName`);

// Detectar si es PDF por tipo MIME o extensi√≥n
const isPDF = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
const isImage = file.type.startsWith('image/');

if (imagePreview) {
    if (isImage) {
        // Es una imagen - mostrar preview
        imagePreview.style.display = 'block';
        imagePreview.style.visibility = 'visible';
        if (imagePreviewImg) {
            imagePreviewImg.style.display = 'block';
            imagePreviewImg.style.visibility = 'visible';
            imagePreviewImg.src = base64;
        }
        if (pdfPreview) {
            pdfPreview.style.display = 'none';
            pdfPreview.style.visibility = 'hidden';
        }
    } else if (isPDF) {
        // Es un PDF - mostrar √≠cono de PDF
        imagePreview.style.display = 'block';
        imagePreview.style.visibility = 'visible';
        if (imagePreviewImg) {
            imagePreviewImg.style.display = 'none';
            imagePreviewImg.style.visibility = 'hidden';
            imagePreviewImg.src = '';
        }
        if (pdfPreview) {
            pdfPreview.style.display = 'block';
            pdfPreview.style.visibility = 'visible';
            if (pdfFileName) {
                pdfFileName.textContent = file.name;
            }
        }
    } else {
        // Otro tipo - ocultar preview
        imagePreview.style.display = 'none';
        imagePreview.style.visibility = 'hidden';
    }
}

// Mostrar preview de informaci√≥n
document.getElementById(`${type}Placeholder`).style.display = 'none';
document.getElementById(`${type}Preview`).style.display = 'block';
document.getElementById(`${type}FileName`).textContent = file.name;
document.getElementById(`${type}FileSize`).textContent = formatFileSize(file.size);

notify.success(`${getDocumentName(type)} cargado correctamente`);
};

reader.onerror = function() {
notify.error('Error al leer el archivo');
};

reader.readAsDataURL(file);
}

function removeDocument(type) {
            document.getElementById(`${type}File`).value = '';
            document.getElementById(`${type}Data`).value = '';
            document.getElementById(`${type}Placeholder`).style.display = 'block';
            document.getElementById(`${type}Preview`).style.display = 'none';
            
            // Ocultar previsualizaci√≥n de imagen/PDF
            const imagePreview = document.getElementById(`${type}ImagePreview`);
            const imagePreviewImg = document.getElementById(`${type}ImagePreviewImg`);
            const pdfPreview = document.getElementById(`${type}PdfPreview`);
            
            if (imagePreview) {
                imagePreview.style.display = 'none';
            }
            if (imagePreviewImg) {
                imagePreviewImg.src = '';
            }
            if (pdfPreview) {
                pdfPreview.style.display = 'none';
            }
            
            notify.info(`${getDocumentName(type)} eliminado`);
        }
        
        function getDocumentName(type) {
            const names = {
                'receta': 'Receta M√©dica',
                'carnet': 'Carnet de Identidad',
                'certificado': 'Certificado de Antecedentes'
            };
            return names[type] || 'Documento';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // ===========================================
        // UTILIDADES
        // ===========================================
        
        // Toggle password visibility
        const togglePasswordBtn = document.getElementById('togglePassword');
        if (togglePasswordBtn) {
            togglePasswordBtn.addEventListener('click', function() {
                const passwordInput = document.getElementById('password');
                const icon = this.querySelector('i');
                
                if (passwordInput && icon) {
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                    } else {
                        passwordInput.type = 'password';
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                }
            });
        }

        // ===========================================
        // SUBMIT DEL FORMULARIO
        // ===========================================
        
        function submitForm() {
            // Validar firma del cediente (obligatoria)
            const cedenteSignatureCanvas = document.getElementById('cedenteSignatureCanvas');
            const cedenteSignatureError = document.getElementById('cedenteSignatureError');
            
            // Verificar si existe el SignaturePad (puede estar en el scope del componente)
            let hasSignature = false;
            
            // Intentar acceder al SignaturePad desde el scope global o del componente
            if (typeof window.cedenteSignaturePad !== 'undefined' && window.cedenteSignaturePad) {
                hasSignature = !window.cedenteSignaturePad.isEmpty();
            } else {
                // Buscar el canvas y verificar si tiene contenido
                if (cedenteSignatureCanvas) {
                    const ctx = cedenteSignatureCanvas.getContext('2d');
                    const imageData = ctx.getImageData(0, 0, cedenteSignatureCanvas.width, cedenteSignatureCanvas.height);
                    // Verificar si hay p√≠xeles no blancos (firma)
                    const hasNonWhitePixels = imageData.data.some((pixel, index) => {
                        if (index % 4 === 3) return false; // Saltar canal alpha
                        return pixel < 255;
                    });
                    hasSignature = hasNonWhitePixels;
                }
            }
            
            // Tambi√©n verificar si el poder de cultivo ya fue generado (contiene la firma)
            const poderCultivoData = document.getElementById('poderCultivoData').value;
            if (poderCultivoData && poderCultivoData.includes('data:image/png;base64')) {
                hasSignature = true;
            }
            
            if (!hasSignature) {
                // Mostrar error en el componente
                if (cedenteSignatureError) {
                    cedenteSignatureError.style.display = 'block';
                }
                
                // Scroll al campo de firma
                if (cedenteSignatureCanvas) {
                    cedenteSignatureCanvas.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Resaltar el canvas
                    cedenteSignatureCanvas.style.border = '2px solid #ef4444';
                    setTimeout(() => {
                        cedenteSignatureCanvas.style.border = '';
                    }, 3000);
                }
                
                notify.error('Debes firmar el documento de poder de cultivo antes de continuar');
                return;
            }
            
            // Ocultar error si la firma est√° presente
            if (cedenteSignatureError) {
                cedenteSignatureError.style.display = 'none';
            }
            
            // Validar documentos
            const receta = document.getElementById('recetaData').value;
            const carnet = document.getElementById('carnetData').value;
            const certificado = document.getElementById('certificadoData').value;
            const poderCultivo = document.getElementById('poderCultivoData').value;
            
            if (!receta || !carnet || !certificado || !poderCultivo) {
                notify.error('Debes cargar los 4 documentos requeridos (Receta M√©dica, Carnet de Identidad, Certificado de Antecedentes y Poder de Cultivo)');
                return;
            }
            
            handleSubmit();
        }
        
        async function handleSubmit() {
            
            // Validar datos del formulario
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            if (!name || !email || !password) {
                notify.error('Por favor completa todos los campos requeridos');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const btnLoader = document.getElementById('btnLoader');
            
            submitBtn.disabled = true;
            btnText.textContent = 'Creando cuenta...';
            btnLoader.style.display = 'inline-block';
            
            try {
                // Separar nombre completo en first_name y last_name
                const fullName = document.getElementById('name').value.trim();
                const nameParts = fullName.split(' ');
                const firstName = nameParts[0] || '';
                const lastName = nameParts.slice(1).join(' ') || '';
                
                // Validar email (usar Utils si est√° disponible, sino validaci√≥n inline)
                let emailValid = false;
                if (typeof Utils !== 'undefined' && Utils.isValidEmail) {
                    emailValid = Utils.isValidEmail(email);
                } else {
                    const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
                    emailValid = email && emailRegex.test(email.trim()) && email.length <= 254;
                }
                
                if (!emailValid) {
                    notify.error('Por favor ingresa un correo electr√≥nico v√°lido');
                    const emailInput = document.getElementById('email');
                    emailInput.style.borderColor = '#ef4444';
                    emailInput.focus();
                    resetSubmitButton();
                    return;
                } else {
                    document.getElementById('email').style.borderColor = '#10b981';
                }
                
                // Validar RUT (obligatorio)
                const rut = document.getElementById('rut').value.trim();
                const rutError = document.getElementById('rutError');
                const rutInput = document.getElementById('rut');
                
                if (!rut || rut.trim() === '') {
                    notify.error('El RUT es obligatorio');
                    if (rutInput) {
                        rutInput.style.borderColor = '#ef4444';
                        rutInput.focus();
                    }
                    if (rutError) {
                        const errorText = rutError.querySelector('#rutErrorText');
                        if (errorText) errorText.textContent = 'Debes ingresar tu RUT';
                        rutError.style.display = 'block';
                    }
                    resetSubmitButton();
                    return;
                }
                
                // Validar formato y d√≠gito verificador del RUT
                let rutValid = false;
                // Limpiar RUT (eliminar puntos, guiones y espacios)
                let cleanRUT = rut.trim().replace(/\./g, '').replace(/-/g, '').replace(/\s/g, '').toUpperCase();
                
                console.log('üîç Validando RUT - Original:', rut, 'Limpiado:', cleanRUT);
                
                // Verificar formato b√°sico (7-8 d√≠gitos + d√≠gito verificador)
                if (/^\d{7,8}[\dkK]$/.test(cleanRUT)) {
                    const body = cleanRUT.slice(0, -1);
                    const dv = cleanRUT.slice(-1).toUpperCase();
                    
                    if (body.length >= 7 && body.length <= 8) {
                        let sum = 0;
                        let multiplier = 2;
                        for (let i = body.length - 1; i >= 0; i--) {
                            sum += parseInt(body[i]) * multiplier;
                            multiplier = multiplier === 7 ? 2 : multiplier + 1;
                        }
                        const remainder = sum % 11;
                        const calculatedDV = remainder === 0 ? '0' : remainder === 1 ? 'K' : (11 - remainder).toString();
                        rutValid = dv === calculatedDV;
                        
                        console.log('üîç RUT validaci√≥n - Body:', body, 'DV ingresado:', dv, 'DV calculado:', calculatedDV, 'V√°lido:', rutValid);
                    }
                } else {
                    console.log('üîç RUT no cumple formato b√°sico:', cleanRUT);
                }
                
                if (!rutValid) {
                    notify.error('El RUT ingresado no es v√°lido. Verifica el formato (ej: 12.345.678-9) y el d√≠gito verificador.');
                    if (rutInput) {
                        rutInput.style.borderColor = '#ef4444';
                        rutInput.focus();
                    }
                    if (rutError) {
                        const errorText = rutError.querySelector('#rutErrorText');
                        if (errorText) errorText.textContent = 'RUT inv√°lido. Verifica el formato y el d√≠gito verificador.';
                        rutError.style.display = 'block';
                    }
                    resetSubmitButton();
                    return;
                } else {
                    if (rutInput) rutInput.style.borderColor = '#10b981';
                    if (rutError) rutError.style.display = 'none';
                    console.log('‚úÖ RUT v√°lido en frontend');
                }
                
                // Validar tel√©fono (obligatorio)
                const phone = document.getElementById('phone').value.trim();
                if (!phone) {
                    notify.error('El tel√©fono es obligatorio');
                    const phoneInput = document.getElementById('phone');
                    phoneInput.style.borderColor = '#ef4444';
                    phoneInput.focus();
                    resetSubmitButton();
                    return;
                } else {
                    document.getElementById('phone').style.borderColor = '';
                }

                // Validar que las contrase√±as coincidan
                const confirmPassword = document.getElementById('confirmPassword').value;
                const passwordInput = document.getElementById('password');
                const confirmPasswordInput = document.getElementById('confirmPassword');
                if (password !== confirmPassword) {
                    notify.error('Las contrase√±as no coinciden');
                    if (confirmPasswordInput) confirmPasswordInput.style.borderColor = '#ef4444';
                    if (passwordInput) passwordInput.style.borderColor = '#ef4444';
                    if (confirmPasswordInput) confirmPasswordInput.focus();
                    resetSubmitButton();
                    return;
                } else {
                    if (passwordInput) passwordInput.style.borderColor = '';
                    if (confirmPasswordInput) confirmPasswordInput.style.borderColor = '';
                }
                
                // Preparar datos seg√∫n nueva estructura de base de datos
                const addressLine1 = document.getElementById('addressLine1').value.trim();
                const addressType = document.getElementById('addressType').value;
                const addressReference = document.getElementById('addressReference').value.trim();
                // Combinar tipo y referencia en addressLine2 si existe alguno
                let addressLine2 = '';
                if (addressType && addressReference) {
                    addressLine2 = `${addressType} ${addressReference}`;
                } else if (addressType) {
                    addressLine2 = addressType;
                } else if (addressReference) {
                    addressLine2 = addressReference;
                }
                
                const regionSelect = document.getElementById('region');
                const citySelect = document.getElementById('city');
                const communeSelect = document.getElementById('commune');
                const region = regionSelect.value;
                const city = citySelect.value;
                const commune = communeSelect.value;
                
                // Limpiar y formatear RUT antes de enviar al backend
                // El backend acepta RUT con o sin puntos, pero debe tener gui√≥n
                let rutFormateado = rut.trim();
                
                // Limpiar puntos y espacios
                let cleanRUTParaEnvio = rutFormateado.replace(/\./g, '').replace(/\s/g, '').toUpperCase();
                
                // Asegurar que tenga gui√≥n antes del d√≠gito verificador
                if (cleanRUTParaEnvio && !cleanRUTParaEnvio.includes('-')) {
                    // Si no tiene gui√≥n, agregarlo antes del √∫ltimo car√°cter
                    if (cleanRUTParaEnvio.length >= 8) {
                        const body = cleanRUTParaEnvio.slice(0, -1);
                        const dv = cleanRUTParaEnvio.slice(-1);
                        cleanRUTParaEnvio = body + '-' + dv;
                    }
                }
                
                // El backend puede aceptar con o sin puntos, pero para asegurar compatibilidad
                // enviaremos con formato est√°ndar: 12.345.678-9
                if (cleanRUTParaEnvio.includes('-')) {
                    const parts = cleanRUTParaEnvio.split('-');
                    if (parts.length === 2) {
                        const body = parts[0];
                        const dv = parts[1];
                        // Agregar puntos cada 3 d√≠gitos desde la derecha
                        const formattedBody = body.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                        rutFormateado = formattedBody + '-' + dv;
                    } else {
                        rutFormateado = cleanRUTParaEnvio;
                    }
                } else {
                    rutFormateado = cleanRUTParaEnvio;
                }
                
                // Validar una vez m√°s antes de enviar (doble verificaci√≥n)
                let cleanRUTFinal = rutFormateado.replace(/\./g, '').replace(/-/g, '').replace(/\s/g, '').toUpperCase();
                if (/^\d{7,8}[\dkK]$/.test(cleanRUTFinal)) {
                    const body = cleanRUTFinal.slice(0, -1);
                    const dv = cleanRUTFinal.slice(-1).toUpperCase();
                    if (body.length >= 7 && body.length <= 8) {
                        let sum = 0;
                        let multiplier = 2;
                        for (let i = body.length - 1; i >= 0; i--) {
                            sum += parseInt(body[i]) * multiplier;
                            multiplier = multiplier === 7 ? 2 : multiplier + 1;
                        }
                        const remainder = sum % 11;
                        const calculatedDV = remainder === 0 ? '0' : remainder === 1 ? 'K' : (11 - remainder).toString();
                        
                        if (dv !== calculatedDV) {
                            console.error('‚ùå RUT inv√°lido antes de enviar:', rutFormateado, 'DV esperado:', calculatedDV, 'DV recibido:', dv);
                            notify.error(`Error: El RUT tiene un d√≠gito verificador incorrecto. Deber√≠a ser "${calculatedDV}"`);
                            resetSubmitButton();
                            return;
                        }
                    }
                }
                
                console.log('üîç RUT original:', rut);
                console.log('üîç RUT formateado para enviar:', rutFormateado);
                console.log('üîç RUT limpio (sin puntos):', cleanRUTFinal);
                
                const userData = {
                    email: email,
                    password: password,
                    first_name: firstName,
                    last_name: lastName,
                    phone: phone,
                    rut: rutFormateado || undefined,
                    // Direcci√≥n solo si se complet√≥ al menos regi√≥n, ciudad y comuna
                    ...(region && city && commune ? {
                        addressLine1: addressLine1 || undefined,
                        addressLine2: addressLine2 || undefined,
                        region: regionSelect.options[regionSelect.selectedIndex]?.textContent || undefined,
                        city: citySelect.options[citySelect.selectedIndex]?.textContent || undefined,
                        commune: commune || undefined
                    } : {})
                };
                
                console.log('üì§ Enviando registro...');
                
                // Intentar registro usando directamente la API
                const response = await api.register(userData);
                
                if (response.success) {
                    // Guardar documentos despu√©s de crear el usuario
                    const userId = response.data.user.id;
                    console.log('üìÑ Guardando documentos para usuario ID:', userId);
                    
                    const poderCultivoData = document.getElementById('poderCultivoData').value;
                    const poderCultivoFileName = document.getElementById('poderCultivoFileName').value || 'poder_cultivo.html';
                    
                    console.log('üìÑ Verificando poder_cultivo antes de guardar:', {
                        has_value: !!poderCultivoData,
                        value_length: poderCultivoData ? poderCultivoData.length : 0,
                        file_name: poderCultivoFileName,
                        preview: poderCultivoData ? poderCultivoData.substring(0, 100) : 'null'
                    });
                    
                    const documentsData = [
                        {
                            document_type: 'receta_medica',
                            file_data: document.getElementById('recetaData').value,
                            file_name: 'receta_medica.pdf'
                        },
                        {
                            document_type: 'carnet_identidad',
                            file_data: document.getElementById('carnetData').value,
                            file_name: 'carnet_identidad.pdf'
                        },
                        {
                            document_type: 'certificado_antecedentes',
                            file_data: document.getElementById('certificadoData').value,
                            file_name: 'certificado_antecedentes.pdf'
                        },
                        {
                            document_type: 'poder_cultivo',
                            file_data: poderCultivoData,
                            file_name: poderCultivoFileName,
                            mime_type: 'text/html'
                        }
                    ];
                    
                    // Enviar documentos
                    await api.saveUserDocuments(userId, documentsData);
                    
                    // Guardar datos de cesi√≥n en user_registrations si existen
                    const tempCessionData = localStorage.getItem('tempCessionData');
                    if (tempCessionData) {
                        try {
                            const cessionData = JSON.parse(tempCessionData);
                            
                            // Preparar datos para user_registrations
                            const registrationData = {
                                user_id: userId,
                                cedente_nombre: cessionData.cedente_nombre,
                                cedente_rut: cessionData.cedente_rut,
                                cedente_firma: cessionData.cedente_firma,
                                enfermedad_condicion: cessionData.enfermedad_condicion, // Se encriptar√° en el backend
                                fecha_inicio: cessionData.fecha_inicio,
                                fecha_termino: cessionData.fecha_termino,
                                es_indefinido: cessionData.es_indefinido,
                                es_revocable: cessionData.es_revocable,
                                dispensario_nombre: cessionData.dispensario_nombre,
                                dispensario_rut: cessionData.dispensario_rut,
                                dispensario_direccion: cessionData.dispensario_direccion,
                                dispensario_firma: cessionData.dispensario_firma,
                                documento_html: document.getElementById('poderCultivoData').value,
                                fecha_cesion: cessionData.fecha_cesion
                            };
                            
                            // Guardar registro en backend (se encriptar√° enfermedad/condici√≥n)
                            const registrationResponse = await api.saveUserRegistration(registrationData);
                            if (registrationResponse.success) {
                                console.log('‚úÖ Datos de registro de usuario guardados correctamente');
                                const registrationId = registrationResponse.data.id;
                                
                                // Guardar documentos asociados a este registro de receta
                                const registrationDocuments = [
                                    {
                                        document_type: 'receta_medica',
                                        file_data: document.getElementById('recetaData').value,
                                        file_name: 'receta_medica.pdf',
                                        mime_type: 'application/pdf'
                                    },
                                    {
                                        document_type: 'carnet_identidad',
                                        file_data: document.getElementById('carnetData').value,
                                        file_name: 'carnet_identidad.pdf',
                                        mime_type: 'application/pdf'
                                    },
                                    {
                                        document_type: 'certificado_antecedentes',
                                        file_data: document.getElementById('certificadoData').value,
                                        file_name: 'certificado_antecedentes.pdf',
                                        mime_type: 'application/pdf'
                                    },
                                    {
                                        document_type: 'poder_cultivo',
                                        file_data: document.getElementById('poderCultivoData').value,
                                        file_name: document.getElementById('poderCultivoFileName').value || 'poder_cultivo.html',
                                        mime_type: 'text/html'
                                    }
                                ];
                                
                                try {
                                    const docsResponse = await api.saveUserRegistrationDocuments(registrationId, userId, registrationDocuments);
                                    if (docsResponse.success) {
                                        console.log('‚úÖ Documentos asociados al registro de receta guardados correctamente');
                                    } else {
                                        console.error('‚ö†Ô∏è Error guardando documentos de registro:', docsResponse.message);
                                    }
                                } catch (error) {
                                    console.error('‚ö†Ô∏è Error guardando documentos de registro:', error);
                                }
                            }
                            
                            // Limpiar datos temporales
                            localStorage.removeItem('tempCessionData');
                        } catch (error) {
                            console.error('Error guardando datos de registro:', error);
                            // No bloquear el flujo si falla guardar el registro
                        }
                    }
                    
                    notify.success('¬°Cuenta creada exitosamente! Tu cuenta est√° pendiente de aprobaci√≥n. Ser√°s notificado cuando sea aprobada.', 'Cuenta pendiente de aprobaci√≥n');
                    
                    setTimeout(() => {
                        window.location.href = './login.html';
                    }, 3000);
                } else {
                    // Manejar errores espec√≠ficos con mensajes personalizados
                    const errorCode = response.error_code;
                    const field = response.field;
                    let errorMessage = response.message || 'Error al crear la cuenta';
                    let errorTitle = 'Error al registrar';
                    
                    // Mensajes personalizados seg√∫n el c√≥digo de error
                    if (errorCode === 'EMAIL_ALREADY_EXISTS') {
                        errorMessage = response.message || 'Este correo electr√≥nico ya est√° registrado. Si ya tienes una cuenta, intenta iniciar sesi√≥n. Si olvidaste tu contrase√±a, puedes recuperarla.';
                        errorTitle = 'Correo ya registrado';
                        // Resaltar el campo de email
                        const emailInput = document.getElementById('email');
                        if (emailInput) {
                            emailInput.style.borderColor = '#ef4444';
                            emailInput.focus();
                        }
                        // Mostrar notificaci√≥n con t√≠tulo
                        notify.error(errorMessage, errorTitle);
                    } else if (errorCode === 'RUT_ALREADY_EXISTS') {
                        errorMessage = response.message || 'Este RUT ya est√° registrado. Cada persona solo puede tener una cuenta.';
                        errorTitle = 'RUT ya registrado';
                        // Resaltar el campo de RUT
                        const rutInput = document.getElementById('rut');
                        if (rutInput) {
                            rutInput.style.borderColor = '#ef4444';
                            rutInput.focus();
                        }
                        notify.error(errorMessage, errorTitle);
                    } else if (errorCode === 'INVALID_RUT') {
                        errorMessage = response.message || 'El RUT ingresado no es v√°lido. Verifica el formato y el d√≠gito verificador.';
                        errorTitle = 'RUT inv√°lido';
                        const rutInput = document.getElementById('rut');
                        if (rutInput) {
                            rutInput.style.borderColor = '#ef4444';
                            rutInput.focus();
                        }
                        notify.error(errorMessage, errorTitle);
                    } else if (errorCode === 'INVALID_EMAIL_FORMAT') {
                        errorMessage = response.message || 'El formato del correo electr√≥nico no es v√°lido.';
                        errorTitle = 'Formato de correo inv√°lido';
                        const emailInput = document.getElementById('email');
                        if (emailInput) {
                            emailInput.style.borderColor = '#ef4444';
                            emailInput.focus();
                        }
                        notify.error(errorMessage, errorTitle);
                    } else {
                        // Error gen√©rico
                        notify.error(errorMessage, errorTitle);
                    }
                    
                    resetSubmitButton();
                }
            } catch (error) {
                console.error('Error en registro:', error);
                let errorMessage = 'Error al conectar con el servidor';
                let errorTitle = 'Error al registrar';
                
                // Si el error tiene informaci√≥n del backend
                if (error.response && error.response.data) {
                    const errorData = error.response.data;
                    errorMessage = errorData.message || error.message || 'Error al crear la cuenta';
                    
                    // Manejar c√≥digos de error espec√≠ficos
                    if (error.error_code === 'EMAIL_ALREADY_EXISTS' || errorData.error_code === 'EMAIL_ALREADY_EXISTS') {
                        errorMessage = errorData.message || 'El correo electr√≥nico "' + (document.getElementById('email')?.value || '') + '" ya est√° registrado en nuestra plataforma. Si ya tienes una cuenta, intenta iniciar sesi√≥n. Si olvidaste tu contrase√±a, puedes recuperarla.';
                        errorTitle = 'Correo ya registrado';
                        const emailInput = document.getElementById('email');
                        if (emailInput) {
                            emailInput.style.borderColor = '#ef4444';
                            emailInput.focus();
                        }
                    } else if (error.error_code === 'RUT_ALREADY_EXISTS' || errorData.error_code === 'RUT_ALREADY_EXISTS') {
                        errorMessage = errorData.message || 'Este RUT ya est√° registrado. Cada persona solo puede tener una cuenta.';
                        errorTitle = 'RUT ya registrado';
                        const rutInput = document.getElementById('rut');
                        if (rutInput) {
                            rutInput.style.borderColor = '#ef4444';
                            rutInput.focus();
                        }
                    } else if (error.error_code === 'INVALID_RUT' || errorData.error_code === 'INVALID_RUT') {
                        errorMessage = errorData.message || 'El RUT ingresado no es v√°lido. Verifica el formato y el d√≠gito verificador.';
                        errorTitle = 'RUT inv√°lido';
                        const rutInput = document.getElementById('rut');
                        if (rutInput) {
                            rutInput.style.borderColor = '#ef4444';
                            rutInput.focus();
                        }
                    } else if (error.error_code === 'INVALID_EMAIL_FORMAT' || errorData.error_code === 'INVALID_EMAIL_FORMAT') {
                        errorMessage = errorData.message || 'El formato del correo electr√≥nico no es v√°lido.';
                        errorTitle = 'Formato de correo inv√°lido';
                        const emailInput = document.getElementById('email');
                        if (emailInput) {
                            emailInput.style.borderColor = '#ef4444';
                            emailInput.focus();
                        }
                    }
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                notify.error(errorMessage, errorTitle);
                resetSubmitButton();
            }
        }
        
        function resetSubmitButton() {
            const submitBtn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const btnLoader = document.getElementById('btnLoader');
            if (submitBtn) submitBtn.disabled = false;
            if (btnText) btnText.textContent = 'Crear Cuenta';
            if (btnLoader) btnLoader.style.display = 'none';
        }
        
        // Prevenir submit del formulario
        document.getElementById('registerForm').addEventListener('submit', (e) => {
            e.preventDefault();
            if (currentStep === 2) {
                submitForm();
            }
        });
        
        // ===========================================
        // INICIALIZACI√ìN
        // ===========================================
        
        // ===========================================
        // CARGAR Y FILTRAR COMBOBOX DE DIRECCIONES
        // ===========================================
        
        let chileLocations = null;
        
        async function loadChileLocations() {
            try {
                const paths = [
                    '../data/chile-locations.json',
                    './data/chile-locations.json',
                    '../../data/chile-locations.json',
                    '/frontend/data/chile-locations.json',
                    '/data/chile-locations.json'
                ];
                
                let response = null;
                let lastError = null;
                
                for (const path of paths) {
                    try {
                        console.log(`üìÇ Intentando cargar desde: ${path}`);
                        response = await fetch(path);
                        if (response.ok) {
                            console.log(`‚úÖ Archivo encontrado en: ${path}`);
                            break;
                        }
                    } catch (err) {
                        lastError = err;
                        continue;
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error(`No se pudo cargar datos de ubicaciones. √öltimo error: ${lastError?.message || 'Archivo no encontrado'}`);
                }
                
                chileLocations = await response.json();
                
                if (!chileLocations || !chileLocations.regions || chileLocations.regions.length === 0) {
                    throw new Error('El archivo JSON no contiene datos v√°lidos');
                }
                
                populateRegions();
                console.log(`‚úÖ Ubicaciones de Chile cargadas correctamente: ${chileLocations.regions.length} regiones`);
            } catch (error) {
                console.error('‚ö†Ô∏è Error cargando ubicaciones:', error);
                chileLocations = { regions: [] };
                console.warn('‚ö†Ô∏è Usando estructura vac√≠a de ubicaciones');
                
                const addressSection = document.getElementById('addressSection');
                if (addressSection) {
                    const errorMsg = document.createElement('p');
                    errorMsg.style.cssText = 'color: #ef4444; font-size: 0.85rem; margin-top: 8px;';
                    errorMsg.textContent = '‚ö†Ô∏è No se pudieron cargar las ubicaciones. Por favor, ingresa la direcci√≥n manualmente.';
                    addressSection.appendChild(errorMsg);
                }
            }
        }
        
        function populateRegions() {
            const regionSelect = document.getElementById('region');
            if (!regionSelect) {
                console.error('‚ùå No se encontr√≥ el selector de regi√≥n');
                return;
            }
            
            regionSelect.innerHTML = '<option value="">Selecciona una regi√≥n</option>';
            
            if (chileLocations && chileLocations.regions) {
                chileLocations.regions.forEach(region => {
                    const option = document.createElement('option');
                    option.value = region.id;
                    option.textContent = region.name;
                    option.dataset.regionData = JSON.stringify(region);
                    regionSelect.appendChild(option);
                });
            }
        }
        
        function loadCitiesForRegion() {
            const regionSelect = document.getElementById('region');
            const citySelect = document.getElementById('city');
            const communeSelect = document.getElementById('commune');
            
            if (!regionSelect || !citySelect || !communeSelect) {
                console.error('‚ùå Faltan elementos del formulario');
                return;
            }
            
            const selectedRegionId = regionSelect.value;
            
            citySelect.innerHTML = '<option value="">Selecciona una ciudad</option>';
            communeSelect.innerHTML = '<option value="">Primero selecciona una ciudad</option>';
            communeSelect.disabled = true;
            communeSelect.style.backgroundColor = '#f5f5f5';
            communeSelect.style.color = '#999';
            communeSelect.style.cursor = 'not-allowed';
            
            if (!selectedRegionId) {
                citySelect.disabled = true;
                citySelect.style.backgroundColor = '#f5f5f5';
                citySelect.style.color = '#999';
                citySelect.style.cursor = 'not-allowed';
                return;
            }
            
            citySelect.disabled = false;
            citySelect.style.backgroundColor = 'white';
            citySelect.style.color = 'inherit';
            citySelect.style.cursor = 'pointer';
            
            const selectedOption = regionSelect.options[regionSelect.selectedIndex];
            if (!selectedOption) return;
            
            const regionData = JSON.parse(selectedOption.dataset.regionData || '{}');
            
            if (regionData.cities && regionData.cities.length > 0) {
                regionData.cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.id;
                    option.textContent = city.name;
                    option.dataset.cityData = JSON.stringify(city);
                    citySelect.appendChild(option);
                });
            }
        }
        
        function loadCommunesForCity() {
            const citySelect = document.getElementById('city');
            const communeSelect = document.getElementById('commune');
            
            if (!citySelect || !communeSelect) {
                console.error('‚ùå Faltan elementos del formulario');
                return;
            }
            
            const selectedCityId = citySelect.value;
            
            communeSelect.innerHTML = '<option value="">Selecciona una comuna</option>';
            
            if (!selectedCityId) {
                communeSelect.disabled = true;
                communeSelect.style.backgroundColor = '#f5f5f5';
                communeSelect.style.color = '#999';
                communeSelect.style.cursor = 'not-allowed';
                return;
            }
            
            communeSelect.disabled = false;
            communeSelect.style.backgroundColor = 'white';
            communeSelect.style.color = 'inherit';
            communeSelect.style.cursor = 'pointer';
            
            const selectedOption = citySelect.options[citySelect.selectedIndex];
            if (!selectedOption) return;
            
            const cityData = JSON.parse(selectedOption.dataset.cityData || '{}');
            
            if (cityData.communes && cityData.communes.length > 0) {
                cityData.communes.forEach(commune => {
                    const option = document.createElement('option');
                    option.value = commune;
                    option.textContent = commune;
                    communeSelect.appendChild(option);
                });
            }
        }
        
        // Inicializar validaciones cuando el DOM est√© listo
        function initializeValidations() {
            // Formatear y validar RUT mientras se escribe
            const rutInput = document.getElementById('rut');
            const rutError = document.getElementById('rutError');
            
            // Funci√≥n para validar RUT
            function validateRUTInput(rutValue) {
                if (!rutValue || rutValue.trim() === '') {
                    if (rutError) {
                        const errorText = rutError.querySelector('#rutErrorText');
                        if (errorText) errorText.textContent = 'Debes ingresar tu RUT';
                        rutError.style.display = 'block';
                    }
                    if (rutInput) rutInput.style.borderColor = '#ef4444';
                    return false;
                }
                
                let cleanRUT = rutValue.trim().replace(/\./g, '').replace(/-/g, '').replace(/\s/g, '').toUpperCase();
                
                if (!/^\d{7,8}[\dkK]$/.test(cleanRUT)) {
                    if (rutError) {
                        const errorText = rutError.querySelector('#rutErrorText');
                        if (errorText) errorText.textContent = 'Formato inv√°lido. Debe ser: 12345678-9';
                        rutError.style.display = 'block';
                    }
                    if (rutInput) rutInput.style.borderColor = '#ef4444';
                    return false;
                }
                
                const body = cleanRUT.slice(0, -1);
                const dv = cleanRUT.slice(-1).toUpperCase();
                
                if (body.length < 7 || body.length > 8) {
                    if (rutError) {
                        const errorText = rutError.querySelector('#rutErrorText');
                        if (errorText) errorText.textContent = 'El RUT debe tener 7 u 8 d√≠gitos';
                        rutError.style.display = 'block';
                    }
                    if (rutInput) rutInput.style.borderColor = '#ef4444';
                    return false;
                }
                
                // Calcular d√≠gito verificador
                let sum = 0;
                let multiplier = 2;
                for (let i = body.length - 1; i >= 0; i--) {
                    sum += parseInt(body[i]) * multiplier;
                    multiplier = multiplier === 7 ? 2 : multiplier + 1;
                }
                const remainder = sum % 11;
                const calculatedDV = remainder === 0 ? '0' : remainder === 1 ? 'K' : (11 - remainder).toString();
                
                if (dv !== calculatedDV) {
                    if (rutError) {
                        const errorText = rutError.querySelector('#rutErrorText');
                        if (errorText) {
                            errorText.textContent = `D√≠gito verificador incorrecto. Deber√≠a ser "${calculatedDV}" en lugar de "${dv}"`;
                        }
                        rutError.style.display = 'block';
                    }
                    if (rutInput) {
                        rutInput.style.borderColor = '#ef4444';
                        // Notificar tambi√©n con notify si est√° disponible
                        if (typeof notify !== 'undefined') {
                            notify.error(`RUT inv√°lido. El d√≠gito verificador deber√≠a ser "${calculatedDV}"`);
                        }
                    }
                    return false;
                }
                
                // RUT v√°lido
                if (rutError) rutError.style.display = 'none';
                if (rutInput) rutInput.style.borderColor = '#10b981';
                return true;
            }
            
            if (rutInput) {
                let rutTimeout;
                
                // Formatear mientras se escribe
                rutInput.addEventListener('input', function(e) {
                    clearTimeout(rutTimeout);
                    let value = e.target.value.replace(/[^0-9kK-]/g, '');
                    
                    // Limpiar y formatear
                    const cleanValue = value.replace(/\./g, '').replace(/-/g, '').toUpperCase();
                    
                    if (cleanValue.length > 1) {
                        // Agregar gui√≥n antes del √∫ltimo car√°cter
                        value = cleanValue.slice(0, -1) + '-' + cleanValue.slice(-1);
                        // Agregar puntos cada 3 d√≠gitos desde la derecha
                        const parts = value.split('-');
                        if (parts.length === 2) {
                            const body = parts[0];
                            const dv = parts[1];
                            let formatted = '';
                            for (let i = body.length - 1, count = 0; i >= 0; i--, count++) {
                                formatted = body[i] + formatted;
                                if (count % 3 === 2 && i > 0) {
                                    formatted = '.' + formatted;
                                }
                            }
                            value = formatted + '-' + dv;
                        }
                    }
                    
                    e.target.value = value;
                    
                    // Validar en tiempo real despu√©s de un peque√±o delay
                    rutTimeout = setTimeout(() => {
                        if (value.length > 0) {
                            validateRUTInput(value);
                        } else {
                            if (rutError) rutError.style.display = 'none';
                            if (rutInput) rutInput.style.borderColor = '';
                        }
                    }, 300);
                });
                
                // Validar al perder el foco (blur)
                rutInput.addEventListener('blur', function(e) {
                    clearTimeout(rutTimeout);
                    validateRUTInput(e.target.value);
                });
                
                // Validar cuando se autocompleta (change) - se dispara cuando el navegador autocompleta
                rutInput.addEventListener('change', function(e) {
                    clearTimeout(rutTimeout);
                    const isValid = validateRUTInput(e.target.value);
                    // Si es inv√°lido, mostrar notificaci√≥n
                    if (!isValid && typeof notify !== 'undefined') {
                        notify.error('El RUT autocompletado no es v√°lido. Por favor, corr√≠gelo antes de continuar.');
                    }
                });
                
                // Tambi√©n validar cuando el campo recibe foco despu√©s de autocompletar
                rutInput.addEventListener('focus', function(e) {
                    // Peque√±o delay para que el navegador complete el valor
                    setTimeout(() => {
                        if (e.target.value && e.target.value.trim() !== '') {
                            validateRUTInput(e.target.value);
                        }
                    }, 100);
                });
                
                // Validar cuando se pega contenido (paste)
                rutInput.addEventListener('paste', function(e) {
                    setTimeout(() => {
                        validateRUTInput(e.target.value);
                    }, 100);
                });
            }
            
            // Validar email en tiempo real
            const emailInput = document.getElementById('email');
            const emailError = document.getElementById('emailError') || (() => {
                // Crear elemento de error si no existe
                const error = document.createElement('p');
                error.id = 'emailError';
                error.style.cssText = 'display: none; color: #ef4444; font-size: 0.875rem; margin-top: 4px;';
                if (emailInput && emailInput.parentElement) {
                    emailInput.parentElement.parentElement.appendChild(error);
                }
                return error;
            })();
            
            // Funci√≥n para validar email
            function validateEmailInput(emailValue) {
                if (!emailValue || emailValue.trim() === '') {
                    if (emailError) {
                        emailError.textContent = 'Debes ingresar tu correo electr√≥nico';
                        emailError.style.display = 'block';
                    }
                    if (emailInput) emailInput.style.borderColor = '#ef4444';
                    return false;
                }
                
                const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
                const isValid = emailRegex.test(emailValue.trim()) && emailValue.length <= 254;
                
                if (!isValid) {
                    if (emailError) {
                        emailError.textContent = 'Formato de correo inv√°lido. Ejemplo: usuario@dominio.com';
                        emailError.style.display = 'block';
                    }
                    if (emailInput) emailInput.style.borderColor = '#ef4444';
                    return false;
                }
                
                // Email v√°lido
                if (emailError) emailError.style.display = 'none';
                if (emailInput) emailInput.style.borderColor = '#10b981';
                return true;
            }
            
            if (emailInput) {
                let emailTimeout;
                
                // Validar mientras se escribe (con delay para no validar en cada tecla)
                emailInput.addEventListener('input', function(e) {
                    clearTimeout(emailTimeout);
                    const value = e.target.value.trim();
                    
                    emailTimeout = setTimeout(() => {
                        if (value.length > 0) {
                            validateEmailInput(value);
                        } else {
                            if (emailError) emailError.style.display = 'none';
                            if (emailInput) emailInput.style.borderColor = '';
                        }
                    }, 300);
                });
                
                // Validar al perder el foco (blur)
                emailInput.addEventListener('blur', function(e) {
                    clearTimeout(emailTimeout);
                    validateEmailInput(e.target.value);
                });
                
                // Validar cuando se autocompleta (change) - se dispara cuando el navegador autocompleta
                emailInput.addEventListener('change', function(e) {
                    clearTimeout(emailTimeout);
                    const isValid = validateEmailInput(e.target.value);
                    // Si es inv√°lido, mostrar notificaci√≥n
                    if (!isValid && typeof notify !== 'undefined') {
                        notify.error('El correo autocompletado no es v√°lido. Por favor, corr√≠gelo antes de continuar.');
                    }
                });
                
                // Tambi√©n validar cuando el campo recibe foco despu√©s de autocompletar
                emailInput.addEventListener('focus', function(e) {
                    // Peque√±o delay para que el navegador complete el valor
                    setTimeout(() => {
                        if (e.target.value && e.target.value.trim() !== '') {
                            validateEmailInput(e.target.value);
                        }
                    }, 100);
                });
                
                // Validar cuando se pega contenido (paste)
                emailInput.addEventListener('paste', function(e) {
                    setTimeout(() => {
                        validateEmailInput(e.target.value);
                    }, 100);
                });
            }
            
            // Validaci√≥n en tiempo real de contrase√±as
            const passwordInput = document.getElementById('password');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const passwordMatchError = document.getElementById('passwordMatchError');
            const passwordMatchSuccess = document.getElementById('passwordMatchSuccess');

            function validatePasswordMatch() {
                const password = passwordInput.value;
                const confirmPassword = confirmPasswordInput.value;
                
                if (confirmPassword.length === 0) {
                    if (passwordMatchError) passwordMatchError.style.display = 'none';
                    if (passwordMatchSuccess) passwordMatchSuccess.style.display = 'none';
                    if (confirmPasswordInput) confirmPasswordInput.style.borderColor = '';
                    return;
                }
                
                if (password.length > 0 && confirmPassword.length > 0) {
                    if (password === confirmPassword) {
                        if (passwordMatchError) passwordMatchError.style.display = 'none';
                        if (passwordMatchSuccess) passwordMatchSuccess.style.display = 'block';
                        if (confirmPasswordInput) confirmPasswordInput.style.borderColor = '#10b981';
                    } else {
                        if (passwordMatchError) passwordMatchError.style.display = 'block';
                        if (passwordMatchSuccess) passwordMatchSuccess.style.display = 'none';
                        if (confirmPasswordInput) confirmPasswordInput.style.borderColor = '#ef4444';
                    }
                }
            }

            if (passwordInput && confirmPasswordInput) {
                passwordInput.addEventListener('input', validatePasswordMatch);
                confirmPasswordInput.addEventListener('input', validatePasswordMatch);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Redirigir si ya est√° autenticado
            if (typeof authManager !== 'undefined' && authManager.isAuthenticated()) {
                window.location.href = './index.html';
                return;
            }
            
            // Inicializar validaciones
            initializeValidations();
            
            setupDragAndDrop();
            updateStepDisplay();
            
            // Configurar fecha m√≠nima para fecha inicio (hoy)
            const fechaInicioInput = document.getElementById('fechaInicio');
            if (fechaInicioInput) {
                const today = new Date().toISOString().split('T')[0];
                fechaInicioInput.min = today;
                fechaInicioInput.value = today; // Valor por defecto: hoy
            }
            
            // Configurar fecha m√≠nima para fecha t√©rmino (debe ser >= fecha inicio)
            const fechaTerminoInput = document.getElementById('fechaTermino');
            const esIndefinidoCheck = document.getElementById('esIndefinido');
            
            if (fechaInicioInput && fechaTerminoInput) {
                fechaInicioInput.addEventListener('change', () => {
                    fechaTerminoInput.min = fechaInicioInput.value;
                    if (fechaTerminoInput.value && fechaTerminoInput.value < fechaInicioInput.value) {
                        fechaTerminoInput.value = '';
                    }
                });
            }
            
            // Manejar checkbox "Indefinido / Revocable"
            if (esIndefinidoCheck && fechaTerminoInput) {
                const fechaTerminoContainer = document.getElementById('fechaTerminoContainer');
                
                // Funci√≥n para mostrar/ocultar campo de fecha t√©rmino
                const toggleFechaTermino = () => {
                    if (esIndefinidoCheck.checked) {
                        // Ocultar campo de fecha t√©rmino
                        if (fechaTerminoContainer) {
                            fechaTerminoContainer.style.display = 'none';
                        }
                        fechaTerminoInput.value = '';
                        fechaTerminoInput.removeAttribute('required');
                    } else {
                        // Mostrar campo de fecha t√©rmino
                        if (fechaTerminoContainer) {
                            fechaTerminoContainer.style.display = 'block';
                        }
                        fechaTerminoInput.setAttribute('required', 'required');
                    }
                };
                
                // Aplicar estado inicial
                toggleFechaTermino();
                
                // Escuchar cambios en el checkbox
                esIndefinidoCheck.addEventListener('change', toggleFechaTermino);
            }
            
            // Cargar ubicaciones de Chile
            console.log('üìç Cargando ubicaciones de Chile...');
            loadChileLocations();
            
            setTimeout(() => {
                const regionSelect = document.getElementById('region');
                const citySelect = document.getElementById('city');
                const communeSelect = document.getElementById('commune');
                
                console.log('üîç Verificando elementos:', {
                    regionSelect: !!regionSelect,
                    citySelect: !!citySelect,
                    communeSelect: !!communeSelect
                });
                
                if (!regionSelect || !citySelect || !communeSelect) {
                    console.error('‚ùå Faltan elementos del formulario de direcci√≥n');
                } else {
                    console.log('‚úÖ Todos los elementos de direcci√≥n est√°n presentes');
                }
            }, 500);
        });
    </script>

    <!-- Sidebar del carrito -->
    <div id="cartSidebar" class="cart-sidebar">
        <div class="cart-header">
            <h3><i class="fas fa-shopping-cart"></i> Carrito de Compras</h3>
            <button id="closeCart" class="cta-button app-button app-button--primary" style="padding: 6px 12px;">Cerrar</button>
        </div>
        <div id="cartItems" class="cart-items"></div>
        <div class="cart-total">
            <div class="total-amount" id="cartTotal">Total: $0</div>
            <a href="./carrito.html" class="cta-button app-button app-button--primary full-width">Ver Carrito Completo</a>
        </div>
    </div>
    <div id="cartOverlay" class="cart-overlay" style="display: none;"></div>

</body>
</html>
</html>