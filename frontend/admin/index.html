<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Apexremedy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style/css_admin.css">
    <link rel="stylesheet" href="style/index.css">
    <script src="./js/basePath.js"></script>
    <script src="./js/config.js"></script>
    <script src="./js/utils.js"></script>
    <script defer src="./js/adminTemplate.js"></script>
</head>
<body>
    <!-- Header se carga autom√°ticamente -->
    <div id="header-container"></div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Header Section -->
        <div class="admin-page-header">
            <div>
                <h1 class="admin-page-title">Panel de Administraci√≥n</h1>
                <p class="admin-page-subtitle">Gestiona usuarios, productos y pedidos desde aqu√≠</p>
            </div>
            <div class="admin-page-actions">
                <button onclick="generateCatalog()" class="admin-btn admin-btn--accent">
                    <i class="fas fa-book admin-btn__icon"></i>Generar Cat√°logo
                </button>
                <button onclick="openCreateModal()" class="admin-btn admin-btn--primary">
                    <i class="fas fa-plus admin-btn__icon"></i>Nuevo Producto
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="admin-grid admin-grid-4 admin-mb-3">
            <div class="admin-stat-card blue">
                <div class="admin-stat-header">
                    <div>
                        <p class="admin-stat-label">Total Usuarios</p>
                        <p id="totalUsers" class="admin-stat-value">
                            <i class="fas fa-spinner fa-spin"></i>
                        </p>
                    </div>
                    <div class="admin-stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
                <div class="admin-stat-footer">
                    <i class="fas fa-arrow-up"></i>
                    <span>Registrados en el sistema</span>
                </div>
            </div>

            <div class="admin-stat-card green">
                <div class="admin-stat-header">
                    <div>
                        <p class="admin-stat-label">Productos</p>
                        <p id="totalProducts" class="admin-stat-value">
                            <i class="fas fa-spinner fa-spin"></i>
                        </p>
                    </div>
                    <div class="admin-stat-icon">
                        <i class="fas fa-box"></i>
                    </div>
                </div>
                <div class="admin-stat-footer">
                    <i class="fas fa-boxes"></i>
                    <span>En el cat√°logo</span>
                </div>
            </div>

            <div class="admin-stat-card yellow">
                <div class="admin-stat-header">
                    <div>
                        <p class="admin-stat-label">Pedidos Pendientes</p>
                        <p id="pendingOrders" class="admin-stat-value">
                            <i class="fas fa-spinner fa-spin"></i>
                        </p>
                    </div>
                    <div class="admin-stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
                <div class="admin-stat-footer">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Requieren atenci√≥n</span>
                </div>
            </div>

            <div class="admin-stat-card purple">
                <div class="admin-stat-header">
                    <div>
                        <p class="admin-stat-label">Ventas Hoy</p>
                        <p id="todaySales" class="admin-stat-value">
                            <i class="fas fa-spinner fa-spin"></i>
                        </p>
                    </div>
                    <div class="admin-stat-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <div class="admin-stat-footer">
                    <i class="fas fa-chart-line"></i>
                    <span>Ingresos del d√≠a</span>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="admin-mb-3">
            <h3 class="admin-section-title">Acciones R√°pidas</h3>
            <div class="admin-quick-actions">
                <a href="./dashboard.html" class="admin-quick-action">
                    <i class="fas fa-chart-line"></i>
                    <h3>Dashboard</h3>
                    <p>An√°lisis completo</p>
                </a>

                <a href="./users.html" class="admin-quick-action">
                    <i class="fas fa-users"></i>
                    <h3>Usuarios</h3>
                    <p>Gestionar usuarios</p>
                </a>

                <a href="./products.html" class="admin-quick-action">
                    <i class="fas fa-box"></i>
                    <h3>Productos</h3>
                    <p>Cat√°logo completo</p>
                </a>

                <a href="./orders.html" class="admin-quick-action">
                    <i class="fas fa-shopping-cart"></i>
                    <h3>Pedidos</h3>
                    <p>Gestionar pedidos</p>
                </a>

                <a href="./payments.html" class="admin-quick-action">
                    <i class="fas fa-credit-card"></i>
                    <h3>Pagos</h3>
                    <p>Sistema de pagos</p>
                </a>
            </div>
        </div>

        <!-- Secondary Actions -->
        <div class="admin-grid admin-grid-3">
            <div class="admin-card">
                <div class="admin-card-row">
                    <h4 class="admin-card-heading">Mi Perfil</h4>
                    <i class="fas fa-user-circle admin-card-row-icon"></i>
                </div>
                <p class="admin-card-text">Actualiza tu informaci√≥n personal y preferencias</p>
                <a href="./perfil.html" class="admin-btn admin-btn--accent admin-full-width admin-text-center">
                    <i class="fas fa-arrow-right admin-btn__icon"></i>
                    <span>Ir a Perfil</span>
                </a>
            </div>

            <div class="admin-card">
                <div class="admin-card-row">
                    <h4 class="admin-card-heading">Sitio Web</h4>
                    <i class="fas fa-globe admin-card-row-icon"></i>
                </div>
                <p class="admin-card-text">Ver el sitio web desde la perspectiva del cliente</p>
                <a href="../index.html" class="admin-btn admin-btn--accent admin-full-width admin-text-center">
                    <i class="fas fa-external-link-alt admin-btn__icon"></i>
                    <span>Ver Sitio</span>
                </a>
            </div>

            <div class="admin-card">
                <div class="admin-card-row">
                    <h4 class="admin-card-heading">Ayuda</h4>
                    <i class="fas fa-question-circle admin-card-row-icon"></i>
                </div>
                <p class="admin-card-text">¬øNecesitas ayuda? Revisa la documentaci√≥n</p>
                <a href="#" class="admin-btn admin-btn--accent admin-full-width admin-text-center">
                    <i class="fas fa-book admin-btn__icon"></i>
                    <span>Documentaci√≥n</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer-container"></div>

    <!-- Scripts -->
    <script src="./js/api/apiClient.js"></script>
    <script src="./js/auth.js"></script>
    <script src="./js/sessionManager.js"></script>
    <script src="./js/notifications.js"></script>
    <script>
// ============================================
// PROTECCI√ìN DE RUTA - SOLO ADMIN
// ============================================
(function() {
    'use strict';
    function checkAdminAccess() {
        if (typeof authManager === 'undefined') {
            window.location.href = '../login.html';
            return;
        }
        if (!authManager.requireAdmin()) {
            return; // requireAdmin ya redirige
        }
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', checkAdminAccess);
    } else {
        checkAdminAccess();
    }
})();
        console.log('üöÄ Iniciando admin dashboard...');
        
        // CREAR INSTANCIA DE API SI NO EXISTE
        if (typeof api === 'undefined' && typeof APIClient !== 'undefined') {
            console.log('‚ö†Ô∏è api no existe globalmente, creando instancia...');
            window.api = new APIClient();
        }
        
        // Verificar que todo est√© cargado
        console.log('‚úîÔ∏è authManager:', typeof authManager);
        console.log('‚úîÔ∏è api:', typeof api);
        console.log('‚úîÔ∏è APIClient:', typeof APIClient);
        
        // Verificar autenticaci√≥n y rol de admin
        function checkAuth() {
            console.log('üîê Verificando autenticaci√≥n...');
            
            if (!authManager.isAuthenticated()) {
                console.log('‚ùå No autenticado, redirigiendo...');
                notify.warning('Debes iniciar sesi√≥n para acceder al panel admin', 'Autenticaci√≥n Requerida');
                window.location.href = '../login.html';
                return false;
            }
            
            const user = authManager.getCurrentUser();
            console.log('üë§ Usuario:', user);
            
            if (!user || user.role !== 'admin') {
                console.log('‚ùå No es admin, redirigiendo...');
                notify.error('Acceso denegado. Solo administradores.', 'Acceso Restringido');
                window.location.href = '../index.html';
                return false;
            }
            
            // document.getElementById('adminName').textContent = user.name;
            console.log('‚úîÔ∏è Admin verificado:', user.name);
            
            return true;
        }

        // Cargar estad√≠sticas
        async function loadStats() {
            console.log('üìä Cargando estad√≠sticas...');
            
            try {
                const token = authManager.getToken();
                console.log('üîë Token:', token ? 'Disponible' : 'No disponible');
                
                // 1. Usuarios
                console.log('üì• Solicitando usuarios...');
                try {
                    const usersResponse = await api.getUsers();
                    console.log('üìä Respuesta usuarios:', usersResponse);
                    
                    if (usersResponse.success) {
                        const users = usersResponse.data?.users || usersResponse.data || [];
                        const count = Array.isArray(users) ? users.length : usersResponse.total || usersResponse.count || 0;
                        document.getElementById('totalUsers').textContent = count;
                        console.log('‚úîÔ∏è Usuarios:', count);
                    } else {
                        document.getElementById('totalUsers').textContent = '0';
                    }
                } catch (error) {
                    console.error('‚ùå Error usuarios:', error);
                    console.error('Detalles:', error.message);
                    document.getElementById('totalUsers').textContent = 'Error';
                }

                // 2. Productos
                console.log('üì• Solicitando productos...');
                try {
                    const productsResponse = await api.getProducts({ limit: 500 });
                    console.log('üìä Respuesta productos:', productsResponse);
                    
                    if (productsResponse.success) {
                        const products = productsResponse.data?.products || productsResponse.data || [];
                        document.getElementById('totalProducts').textContent = products.length;
                        console.log('‚úîÔ∏è Productos:', products.length);
                    } else {
                        document.getElementById('totalProducts').textContent = '0';
                    }
                } catch (error) {
                    console.error('‚ùå Error productos:', error);
                    document.getElementById('totalProducts').textContent = '0';
                }

                // 3. Pedidos
                console.log('üì• Solicitando pedidos...');
                try {
                    const ordersResponse = await api.getAllOrders({ limit: 1000 });
                    console.log('üìä Respuesta pedidos:', ordersResponse);
                    
                    if (ordersResponse.success) {
                        const orders = ordersResponse.data?.orders || ordersResponse.data || [];
                        const pending = orders.filter(o => o.status === 'pending' || o.status === 'pending_payment').length;
                        document.getElementById('pendingOrders').textContent = pending;
                        
                        const today = new Date().toISOString().split('T')[0];
                        const todayOrders = orders.filter(o => o.created_at && o.created_at.startsWith(today));
                        const todaySales = todayOrders.reduce((sum, o) => sum + (o.total || 0), 0);
                        document.getElementById('todaySales').textContent = `$${todaySales.toLocaleString()}`;
                        
                        console.log('‚úîÔ∏è Pedidos pendientes:', pending);
                        console.log('‚úîÔ∏è Ventas hoy:', todaySales);
                    } else {
                        document.getElementById('pendingOrders').textContent = '0';
                        document.getElementById('todaySales').textContent = '$0';
                    }
                } catch (error) {
                    console.error('‚ùå Error pedidos:', error);
                    document.getElementById('pendingOrders').textContent = '0';
                    document.getElementById('todaySales').textContent = '$0';
                }
                
                console.log('‚úîÔ∏è Estad√≠sticas cargadas completamente');
            } catch (error) {
                console.error('‚ùå Error general:', error);
            }
        }

        // Cerrar sesi√≥n
/*         document.getElementById('logoutBtn').addEventListener('click', () => {
            if (confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
                console.log('üëã Cerrando sesi√≥n...');
                authManager.logout();
            }
        }); */

        // Inicializar
        console.log('üèÅ Inicializando...');
        if (checkAuth()) {
            loadStats();
        }
    </script>
</body>
</html>