<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - Apexremedy Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style/css_admin.css">
    <link rel="stylesheet" href="style/perfil.css">
    <script src="./js/config.js"></script>
    <script src="./js/utils.js"></script>
    <script defer src="./js/adminTemplate.js"></script>
</head>
<body>
    <!-- Header se carga autom√°ticamente -->
    <div id="header-container"></div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Mi Perfil</h1>
            <p class="text-gray-600 mt-1">Gestiona tu informaci√≥n personal y configuraci√≥n</p>
        </div>

        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Men√∫ lateral -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="text-center mb-6">
                        <div class="w-24 h-24 bg-gradient-to-br from-orange-600 to-red-700 rounded-full mx-auto mb-4 flex items-center justify-center" style="background: linear-gradient(135deg, var(--admin-primary-red), var(--admin-dark-red));">
                            <i class="fas fa-user text-4xl text-white"></i>
                        </div>
                        <h2 id="userName" class="text-xl font-bold text-gray-800">Cargando...</h2>
                        <p id="userEmail" class="text-gray-500 text-sm mt-1">...</p>
                        <span id="userRole" class="inline-block mt-2 px-3 py-1 text-xs font-semibold rounded-full" style="background: rgba(192, 86, 33, 0.1); color: var(--admin-primary-red);"></span>
                    </div>

                    <nav class="space-y-2">
                        <button onclick="showSection('info')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 transition flex items-center gap-3 section-btn active font-semibold" style="background: linear-gradient(135deg, rgba(192, 86, 33, 0.1), rgba(192, 86, 33, 0.05)); color: var(--admin-primary-red);">
                            <i class="fas fa-user-circle"></i>
                            <span>Informaci√≥n Personal</span>
                        </button>
                        <button onclick="showSection('password')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 transition flex items-center gap-3 section-btn">
                            <i class="fas fa-lock"></i>
                            <span>Cambiar Contrase√±a</span>
                        </button>
                        <hr class="my-2">
                        <a href="./index.html" class="block px-4 py-3 rounded-lg hover:bg-gray-100 transition flex items-center gap-3 text-gray-700">
                            <i class="fas fa-arrow-left"></i>
                            <span>Volver al Panel</span>
                        </a>
                    </nav>
                </div>
            </div>

            <!-- Contenido -->
            <div class="lg:col-span-2">
                <!-- Informaci√≥n Personal -->
                <div id="infoSection" class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Informaci√≥n Personal</h2>
                        <i class="fas fa-user-edit text-2xl" style="color: var(--admin-primary-red);"></i>
                    </div>
                    
                    <form id="profileForm" class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label>
                                <input type="text" id="name" required 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-600 focus:border-transparent">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                                <input type="email" id="email" required 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-600 focus:border-transparent">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tel√©fono</label>
                                <input type="tel" id="phone" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-600 focus:border-transparent"
                                       placeholder="+56 9 1234 5678">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">RUT</label>
                                <input type="text" id="rut" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-600 focus:border-transparent"
                                       placeholder="12.345.678-9">
                            </div>
                        </div>

                        <div class="flex gap-3 pt-4">
                            <button type="submit" class="text-white px-6 py-3 rounded-lg font-semibold transition" style="background: linear-gradient(135deg, var(--admin-primary-red), var(--admin-dark-red));" onmouseover="this.style.background='linear-gradient(135deg, var(--admin-light-red), var(--admin-primary-red))'" onmouseout="this.style.background='linear-gradient(135deg, var(--admin-primary-red), var(--admin-dark-red))'">
                                <i class="fas fa-save mr-2"></i>Guardar Cambios
                            </button>
                            <button type="button" onclick="loadProfile()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-3 rounded-lg font-semibold transition">
                                <i class="fas fa-undo mr-2"></i>Cancelar
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Cambiar Contrase√±a -->
                <div id="passwordSection" class="hidden bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Cambiar Contrase√±a</h2>
                        <i class="fas fa-key text-2xl" style="color: var(--admin-primary-red);"></i>
                    </div>
                    
                    <div class="rounded-lg p-4 mb-6" style="background: rgba(192, 86, 33, 0.05); border: 1px solid rgba(192, 86, 33, 0.2);">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-info-circle text-xl mt-1" style="color: var(--admin-primary-red);"></i>
                            <div>
                                <p class="text-sm font-semibold mb-1" style="color: var(--admin-dark-red);">Requisitos de seguridad</p>
                                <ul class="text-sm space-y-1" style="color: var(--admin-medium-gray);">
                                    <li>‚Ä¢ M√≠nimo 6 caracteres</li>
                                    <li>‚Ä¢ Usa contrase√±as seguras y √∫nicas</li>
                                    <li>‚Ä¢ No compartas tu contrase√±a</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <form id="passwordForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a Actual *</label>
                            <input type="password" id="currentPassword" required 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-600 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nueva Contrase√±a *</label>
                            <input type="password" id="newPassword" required minlength="6" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-600 focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">M√≠nimo 6 caracteres</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Confirmar Nueva Contrase√±a *</label>
                            <input type="password" id="confirmPassword" required minlength="6" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-600 focus:border-transparent">
                        </div>

                        <div class="flex gap-3 pt-4">
                            <button type="submit" class="text-white px-6 py-3 rounded-lg font-semibold transition" style="background: linear-gradient(135deg, var(--admin-primary-red), var(--admin-dark-red));" onmouseover="this.style.background='linear-gradient(135deg, var(--admin-light-red), var(--admin-primary-red))'" onmouseout="this.style.background='linear-gradient(135deg, var(--admin-primary-red), var(--admin-dark-red))'">
                                <i class="fas fa-key mr-2"></i>Cambiar Contrase√±a
                            </button>
                            <button type="button" onclick="document.getElementById('passwordForm').reset()" 
                                    class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-3 rounded-lg font-semibold transition">
                                <i class="fas fa-times mr-2"></i>Limpiar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer-container"></div>

    <!-- Scripts -->
    <script src="./js/api/apiClient.js"></script>
    <script src="./js/auth.js"></script>
    <script src="./js/notifications.js"></script>
    <script>
        // ============================================
        // PROTECCI√ìN DE RUTA - REQUIERE AUTENTICACI√ìN
        // ============================================
        (function() {
            'use strict';
            function checkAuth() {
                if (typeof authManager === 'undefined') {
                    console.error('authManager no disponible');
                    window.location.href = '../login.html';
                    return;
                }
                if (!authManager.isAuthenticated()) {
                    alert('Debes iniciar sesi√≥n para acceder a tu perfil');
                    window.location.href = '../login.html?redirect=admin/perfil';
                    return;
                }
                console.log('‚úÖ Usuario autenticado');
            }
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', checkAuth);
            } else {
                checkAuth();
            }
        })();

        // DESPU√âS de la protecci√≥n, cargar perfil
        document.addEventListener('DOMContentLoaded', () => {
            loadProfile();
        });

// Cargar perfil
async function loadProfile() {
    try {
        console.log('üì• Cargando perfil del usuario...');
        
        const response = await api.getProfile();
        
        if (response && response.success) {
            const user = response.data.user || response.data;
            console.log('‚úÖ Perfil cargado desde API:', user);
            updateUIWithUser(user);
        } else {
            throw new Error('No se pudo cargar el perfil');
        }
    } catch (error) {
        console.warn('‚ö†Ô∏è Error al cargar desde API:', error.message);
        
        // Fallback: usar datos del localStorage
        const currentUser = authManager.getCurrentUser();
        if (currentUser) {
            console.log('‚úÖ Usando perfil desde localStorage:', currentUser);
            updateUIWithUser(currentUser);
        } else {
            showNotification('Error al cargar perfil. Por favor, inicia sesi√≥n nuevamente.', 'error');
            setTimeout(() => {
                authManager.logout();
            }, 2000);
        }
    }
}

        // Actualizar UI con datos del usuario
        function updateUIWithUser(user) {
            const userName = user.name || `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'Usuario';
            document.getElementById('userName').textContent = userName;
            document.getElementById('userEmail').textContent = user.email || '';
            document.getElementById('userRole').textContent = user.role === 'admin' ? 'Administrador' : 'Cliente';
            
            // Actualizar navbar
            const adminNameNav = document.getElementById('adminNameNav');
            if (adminNameNav) {
                const firstName = userName.split(' ')[0];
                adminNameNav.textContent = firstName;
            }
            
            document.getElementById('name').value = user.name || `${user.first_name || ''} ${user.last_name || ''}`.trim() || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('phone').value = user.phone || '';
            document.getElementById('rut').value = user.rut || '';
        }

        // Actualizar perfil
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                name: document.getElementById('name').value.trim(),
                email: document.getElementById('email').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                rut: document.getElementById('rut').value.trim()
            };

            if (!data.name || !data.email) {
                showNotification('El nombre y email son obligatorios', 'error');
                return;
            }

            try {
                const response = await api.updateProfile(data);

                if (response && response.success) {
                    showNotification('Perfil actualizado correctamente', 'success');
                    
                    const updatedUser = response.data.user || response.data;
                    const currentUser = authManager.getCurrentUser();
                    authManager.currentUser = { ...currentUser, ...updatedUser };
                    localStorage.setItem('currentUser', JSON.stringify(authManager.currentUser));
                    
                    loadProfile();
                    
                    if (authManager.updateUI) {
                        authManager.updateUI();
                    }
                } else {
                    throw new Error(response.message || 'Error al actualizar perfil');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error al actualizar perfil: ' + error.message, 'error');
            }
        });

        // Cambiar contrase√±a
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                showNotification('Todos los campos son obligatorios', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showNotification('La nueva contrase√±a debe tener al menos 6 caracteres', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showNotification('Las contrase√±as no coinciden', 'error');
                return;
            }

            try {
                const response = await api.request('/auth/change-password', {
                    method: 'POST',
                    body: JSON.stringify({
                        currentPassword,
                        newPassword
                    })
                });

                if (response && response.success) {
                    showNotification('Contrase√±a cambiada correctamente', 'success');
                    document.getElementById('passwordForm').reset();
                } else {
                    throw new Error(response.message || 'Error al cambiar contrase√±a');
                }
            } catch (error) {
                console.error('Error:', error);
                
                if (error.message.includes('404') || error.message.includes('Not Found')) {
                    showNotification('La funcionalidad de cambio de contrase√±a a√∫n no est√° implementada. Contacta al administrador.', 'warning');
                } else {
                    showNotification('Error al cambiar contrase√±a: ' + error.message, 'error');
                }
            }
        });

        // Cambiar secci√≥n
        function showSection(section) {
            document.getElementById('infoSection').classList.add('hidden');
            document.getElementById('passwordSection').classList.add('hidden');

            document.querySelectorAll('.section-btn').forEach(btn => {
                btn.classList.remove('active', 'font-semibold');
                btn.style.background = '';
                btn.style.color = '';
            });

            const clickedBtn = event.target.closest('.section-btn');
            
            if (section === 'info') {
                document.getElementById('infoSection').classList.remove('hidden');
                if (clickedBtn) {
                    clickedBtn.classList.add('active', 'font-semibold');
                    clickedBtn.style.background = 'linear-gradient(135deg, rgba(192, 86, 33, 0.1), rgba(192, 86, 33, 0.05))';
                    clickedBtn.style.color = 'var(--admin-primary-red)';
                }
            } else if (section === 'password') {
                document.getElementById('passwordSection').classList.remove('hidden');
                if (clickedBtn) {
                    clickedBtn.classList.add('active', 'font-semibold');
                    clickedBtn.style.background = 'linear-gradient(135deg, rgba(192, 86, 33, 0.1), rgba(192, 86, 33, 0.05))';
                    clickedBtn.style.color = 'var(--admin-primary-red)';
                }
            }
        }

        // Confirmar logout
        function confirmLogout() {
            if (confirm('¬øEst√°s seguro de cerrar sesi√≥n?')) {
                authManager.logout();
            }
        }

        // Sistema de notificaciones
        function showNotification(message, type = 'info') {
            if (typeof notify !== 'undefined') {
                notify[type](message);
            } else {
                const icons = {
                    success: '‚úÖ',
                    error: '‚ùå',
                    warning: '‚ö†Ô∏è',
                    info: '‚ÑπÔ∏è'
                };
                alert(`${icons[type]} ${message}`);
            }
        }
    </script>

    <style>
    .group:hover .group-hover\:opacity-100 {
        opacity: 1;
    }
    .group:hover .group-hover\:visible {
        visibility: visible;
    }
    </style>
</body>
</html>