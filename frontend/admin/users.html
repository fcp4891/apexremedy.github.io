<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios - Apexremedy Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style/css_admin.css">
    <link rel="stylesheet" href="style/users.css">
    <script src="./js/basePath.js"></script>
    <script src="./js/config.js"></script>
    <script src="./js/utils.js"></script>
    <script type="module" src="./js/adminTemplate.legacy.js"></script>
    <script defer src="./js/adminTemplate.js"></script>
</head>
<body>
    <!-- Header se carga automáticamente -->
    <div id="header-container"></div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Header Section -->
        <div class="admin-page-header">
            <div>
                <h1 class="admin-page-title">Gestión de Usuarios</h1>
                <p class="admin-page-subtitle">Administra y aprueba cuentas de usuario</p>
            </div>
            <div class="admin-page-actions">
                <button class="admin-btn admin-btn--primary" title="Agregar nuevo usuario" data-action="open-add-user-modal">
                    <i class="fas fa-user-plus admin-btn__icon"></i>
                    <span>Agregar Usuario</span>
                </button>
                <button class="admin-btn admin-btn--accent" title="Guía de aprobación de usuarios" data-action="show-approval-guide">
                    <i class="fas fa-info-circle admin-btn__icon"></i>
                    <span>Guía de Aprobación</span>
                </button>
            </div>
        </div>

        <!-- Estadísticas -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Total Usuarios</p>
                        <p id="totalUsers" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-full">
                        <i class="fas fa-users text-blue-600 text-2xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Pendientes</p>
                        <p id="pendingUsers" class="text-3xl font-bold text-yellow-600">0</p>
                    </div>
                    <div class="bg-yellow-100 p-4 rounded-full">
                        <i class="fas fa-clock text-yellow-600 text-2xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Aprobados</p>
                        <p id="approvedUsers" class="text-3xl font-bold text-green-600">0</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-full">
                        <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Rechazados</p>
                        <p id="rejectedUsers" class="text-3xl font-bold text-red-600">0</p>
                    </div>
                    <div class="bg-red-100 p-4 rounded-full">
                        <i class="fas fa-times-circle text-red-600 text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-8">
                <button id="tab-manage-users" class="tab-button active px-4 py-3 text-base font-semibold border-b-2 border-green-600 text-green-600" data-action="switch-users-tab" data-tab-name="manage">
                    <i class="fas fa-users mr-2"></i>Gestionar Usuarios
                </button>
                <button id="tab-rbac" class="tab-button px-4 py-3 text-base font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-action="switch-users-tab" data-tab-name="rbac">
                    <i class="fas fa-user-shield mr-2"></i>Roles y Permisos
                </button>
            </nav>
        </div>

        <!-- Tab Content Container -->
        <div id="users-tab-content-container">
            <!-- Manage Users Tab Content -->
            <div id="content-manage-users" class="users-tab-content">
                <!-- Filtros -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <input type="text" id="searchInput" placeholder="Buscar por nombre o email..." 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                </div>
                <select id="statusFilter" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                    <option value="">Todos los estados</option>
                    <option value="pending">Pendientes</option>
                    <option value="approved">Aprobados</option>
                    <option value="forced_approved">Aprobados Forzosamente</option>
                    <option value="rejected">Rechazados</option>
                </select>
                <select id="roleFilter" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                    <option value="">Todos los roles</option>
                    <option value="customer">Clientes</option>
                    <option value="admin">Administradores</option>
                </select>
            </div>
        </div>

        <!-- Tabla de Usuarios -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">ID</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Usuario</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Contacto</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Rol</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Estado</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Registro</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="7" class="px-6 py-12 text-center">
                                <i class="fas fa-spinner fa-spin text-4xl text-green-600"></i>
                                <p class="text-gray-500 mt-2">Cargando usuarios...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Ver Documentos -->
    <div id="documentsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Documentos del Usuario</h2>
                    <button class="text-gray-400 hover:text-gray-600" data-action="close-documents-modal">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <div id="documentsContent" class="space-y-6">
                    <!-- Contenido dinámico -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Aprobar -->
    <div id="approveModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Aprobar Cuenta</h2>
                    <button class="text-gray-400 hover:text-gray-600" data-action="close-approve-modal">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <form id="approveForm">
                    <input type="hidden" id="approveUserId">
                    
                    <p class="text-gray-600 mb-4">
                        ¿Estás seguro de aprobar la cuenta de <strong id="approveUserName"></strong>?
                    </p>

                    <!-- Checkbox para aprobación forzada -->
                    <div class="mb-4 p-4 bg-orange-50 border border-orange-200 rounded-lg">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="forceApprove" 
                                   data-action="toggle-force-approve"
                                   class="w-4 h-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                            <span class="ml-3 text-sm font-medium text-orange-800">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                Aprobación Forzada
                            </span>
                        </label>
                        <p class="text-xs text-orange-700 mt-2 ml-7">
                            Marca esta opción si el usuario no cumple completamente con los requisitos pero deseas aprobarlo de todas formas.
                        </p>
                    </div>

                    <!-- Campo de notas - obligatorio si es forzada -->
                    <div class="mb-4" id="approveNotesContainer">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Notas del Administrador <span id="approveNotesRequired" class="text-red-600 hidden">*</span>
                        </label>
                        <textarea id="approveNotes" rows="4" 
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                  placeholder="Explica el motivo de la aprobación..."></textarea>
                        <p id="approveNotesHelper" class="text-xs text-gray-500 mt-1">
                            Notas opcionales para la aprobación estándar.
                        </p>
                    </div>

                    <div class="flex gap-3">
                        <button type="submit" class="admin-btn admin-btn--primary flex-1">
                            <i class="fas fa-check admin-btn__icon"></i>Aprobar
                        </button>
                        <button type="button" class="admin-btn admin-btn--muted flex-1" data-action="close-approve-modal">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Rechazar -->
    <div id="rejectModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Rechazar Cuenta</h2>
                    <button class="text-gray-400 hover:text-gray-600" data-action="close-reject-modal">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <form id="rejectForm">
                    <input type="hidden" id="rejectUserId">
                    
                    <p class="text-gray-600 mb-4">
                        Vas a rechazar la cuenta de <strong id="rejectUserName"></strong>.
                    </p>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Razón del Rechazo *</label>
                        <textarea id="rejectReason" rows="3" required
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"
                                  placeholder="Especifica la razón del rechazo..."></textarea>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notas Internas (opcional)</label>
                        <textarea id="rejectNotes" rows="2"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"
                                  placeholder="Notas adicionales..."></textarea>
                    </div>

                    <div class="flex gap-3">
                        <button type="submit" class="admin-btn admin-btn--danger flex-1">
                            <i class="fas fa-times admin-btn__icon"></i>Rechazar
                        </button>
                        <button type="button" class="admin-btn admin-btn--muted flex-1" data-action="close-reject-modal">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
<!-- Modal Editar Usuario -->
<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Editar Usuario</h2>
                <button class="text-gray-400 hover:text-gray-600" data-action="close-edit-modal">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <form id="editForm">
                <input type="hidden" id="editUserId">
                
                <div class="space-y-4">
                    <!-- Nombre -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label>
                        <input type="text" id="editName" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>

                    <!-- Email -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                        <input type="email" id="editEmail" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>

                    <!-- Teléfono y RUT -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Teléfono</label>
                            <input type="tel" id="editPhone"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                   placeholder="+56912345678">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">RUT</label>
                            <input type="text" id="editRut"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                   placeholder="12345678-9">
                        </div>
                    </div>

                    <!-- Rol -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Rol *</label>
                        <select id="editRole" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">Cargando roles...</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Selecciona el rol del usuario</p>
                    </div>

                    <!-- Estado de Cuenta -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Estado de Cuenta *</label>
                        <select id="editAccountStatus" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="pending">Pendiente</option>
                            <option value="approved">Aprobado</option>
                            <option value="forced_approved">Aprobado Forzosamente</option>
                            <option value="rejected">Rechazado</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Cambiar el estado aquí actualizará el acceso del usuario</p>
                    </div>

                    <!-- Direcciones -->
                    <div id="editAddressesSection">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-map-marker-alt mr-2"></i>Direcciones de Entrega
                        </label>
                        <div id="editAddressesList" class="space-y-3">
                            <p class="text-sm text-gray-500">Cargando direcciones...</p>
                        </div>
                    </div>

                    <!-- Info adicional -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-info-circle text-blue-600 text-xl mt-1"></i>
                            <div class="text-sm text-blue-800">
                                <p class="font-semibold mb-1">Información</p>
                                <ul class="space-y-1">
                                    <li>• El email debe ser único en el sistema</li>
                                    <li>• Solo se actualizarán los campos modificados</li>
                                    <li>• Si no hay cambios, la información se mantiene inalterable</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button type="submit" class="admin-btn admin-btn--accent flex-1">
                        <i class="fas fa-save admin-btn__icon"></i>Guardar Cambios
                    </button>
                    <button type="button" class="admin-btn admin-btn--muted flex-1" data-action="close-edit-modal">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

    <!-- Modal Agregar Usuario -->
    <div id="addUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Agregar Nuevo Usuario</h2>
                    <button class="text-gray-400 hover:text-gray-600" data-action="close-add-user-modal">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <!-- Selector de Rol -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-user-shield mr-2"></i>Rol del Usuario *
                    </label>
                    <select id="userTypeSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" data-action="user-type-change">
                        <option value="">Cargando roles...</option>
                    </select>
                    <p id="roleDescription" class="text-xs text-gray-500 mt-1">Selecciona el rol que tendrá el usuario en el sistema</p>
                </div>

                <!-- Pestañas -->
                <div class="flex border-b border-gray-200 mb-6">
                    <button class="flex-1 px-6 py-3 text-center font-semibold text-gray-700 border-b-2 border-green-600 transition" data-action="switch-user-modal-tab" data-tab="customer" id="tabCustomer">
                        <i class="fas fa-user mr-2"></i><span id="tabCustomerLabel">Cliente</span>
                    </button>
                    <button class="flex-1 px-6 py-3 text-center font-semibold text-gray-500 border-b-2 border-transparent transition" data-action="switch-user-modal-tab" data-tab="admin" id="tabAdmin">
                        <i class="fas fa-user-shield mr-2"></i><span id="tabAdminLabel">Administrador</span>
                    </button>
                </div>

                <!-- Formulario Cliente -->
                <form id="addCustomerForm" class="user-form-tab">
                    <div class="space-y-6">
                        <!-- Información Personal -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <i class="fas fa-user-circle text-green-600"></i>
                                Información Personal
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Nombre Completo -->
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label>
                                    <div class="relative">
                                        <i class="fas fa-user absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                        <input type="text" id="customerName" required
                                               class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                               placeholder="Juan Pérez">
                                    </div>
                                </div>

                                <!-- Email -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Correo Electrónico *</label>
                                    <div class="relative">
                                        <i class="fas fa-envelope absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                        <input type="email" id="customerEmail" required
                                               class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                               placeholder="tu@email.com">
                                    </div>
                                </div>

                                <!-- Teléfono -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Teléfono *</label>
                                    <div class="relative">
                                        <i class="fas fa-phone absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                        <input type="tel" id="customerPhone" required
                                               class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                               placeholder="+56912345678">
                                    </div>
                                </div>

                                <!-- RUT -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">RUT</label>
                                    <div class="relative">
                                        <i class="fas fa-id-card absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                        <input type="text" id="customerRut"
                                               class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                               placeholder="12345678-9">
                                    </div>
                                </div>
                            </div>

                            <!-- Dirección (Opcional) -->
                            <div class="mt-6">
                                <h4 class="text-md font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                    <i class="fas fa-map-marker-alt text-gray-600"></i>
                                    Dirección de Entrega (Opcional)
                                </h4>
                                <p class="text-xs text-gray-500 mb-3">Puedes agregarla ahora o más tarde en el proceso de compra</p>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Calle y número</label>
                                        <div class="relative">
                                            <i class="fas fa-home absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                            <input type="text" id="customerAddressLine1"
                                                   class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                                   placeholder="Calle y número">
                                        </div>
                                    </div>
                                    
                                    <!-- Tipo de dirección (Depto/Casa/Oficina) -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo (opcional)</label>
                                        <div class="relative">
                                            <i class="fas fa-building absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 z-10"></i>
                                            <select id="customerAddressType"
                                                    class="w-full pl-10 pr-10 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 appearance-none bg-white cursor-pointer">
                                                <option value="">Tipo (opcional)</option>
                                                <option value="Depto">Depto</option>
                                                <option value="Casa">Casa</option>
                                                <option value="Oficina">Oficina</option>
                                            </select>
                                            <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                                        </div>
                                    </div>
                                    
                                    <!-- Referencia (texto aparte) -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Referencia (opcional)</label>
                                        <div class="relative">
                                            <i class="fas fa-info-circle absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                            <input type="text" id="customerAddressReference"
                                                   class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                                   placeholder="Ej: Frente a plaza">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Comuna</label>
                                        <div class="relative">
                                            <i class="fas fa-map-pin absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                            <input type="text" id="customerCommune"
                                                   class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                                   placeholder="Comuna">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Ciudad</label>
                                        <div class="relative">
                                            <i class="fas fa-city absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                            <input type="text" id="customerCity"
                                                   class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                                   placeholder="Ciudad">
                                        </div>
                                    </div>
                                    
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Región</label>
                                        <div class="relative">
                                            <i class="fas fa-globe-americas absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                            <input type="text" id="customerRegion"
                                                   class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                                   placeholder="Región (ej: Región Metropolitana)">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                                <!-- Contraseña -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Contraseña *</label>
                                    <div class="relative">
                                        <i class="fas fa-lock absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                        <input type="password" id="customerPassword" required minlength="6"
                                               class="w-full pl-10 pr-10 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                               placeholder="••••••••">
                                        <button type="button" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600" 
                                                data-action="toggle-password-visibility" data-target-input="customerPassword" data-toggle-icon="toggleCustomerPassword">
                                            <i id="toggleCustomerPassword" class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Mínimo 6 caracteres</p>
                                </div>

                                <!-- Confirmar Contraseña -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Confirmar Contraseña *</label>
                                    <div class="relative">
                                        <i class="fas fa-lock absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                        <input type="password" id="customerConfirmPassword" required minlength="6"
                                               class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                               placeholder="••••••••">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Documentos -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <i class="fas fa-file-medical text-green-600"></i>
                                Documentación Requerida
                            </h3>
                            <p class="text-sm text-gray-600 mb-4">Formatos aceptados: PDF, JPG, PNG (máx. 5MB cada uno)</p>

                            <!-- Receta Médica -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                    <i class="fas fa-prescription text-green-600"></i>
                                    Receta Médica *
                                </label>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-green-400 transition" 
                                     id="uploadRecetaZone" data-action="trigger-file-input" data-target-input="recetaFileInput">
                                    <input type="file" id="recetaFileInput" accept=".pdf,.jpg,.jpeg,.png" class="hidden" data-action="document-input" data-document-type="receta">
                                    <div id="recetaPlaceholderContent">
                                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                                        <p class="text-gray-600 font-semibold">Arrastra tu receta médica aquí</p>
                                        <p class="text-sm text-gray-500 mt-1">o haz clic para seleccionar</p>
                                    </div>
                                    <div id="recetaPreviewContent" class="hidden">
                                        <i class="fas fa-file-pdf text-4xl text-green-600 mb-3"></i>
                                        <p id="recetaFileName" class="font-semibold text-green-600"></p>
                                        <p id="recetaFileSize" class="text-sm text-gray-500"></p>
                                        <button type="button" class="mt-2 text-red-600 hover:text-red-800 text-sm" data-action="remove-document" data-document-type="receta">
                                            <i class="fas fa-trash mr-1"></i>Eliminar
                                        </button>
                                    </div>
                                </div>
                                <input type="hidden" id="recetaData">
                            </div>

                            <!-- Carnet de Identidad -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                    <i class="fas fa-id-card text-blue-600"></i>
                                    Carnet de Identidad *
                                </label>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-400 transition" 
                                     id="uploadCarnetZone" data-action="trigger-file-input" data-target-input="carnetFileInput">
                                    <input type="file" id="carnetFileInput" accept=".pdf,.jpg,.jpeg,.png" class="hidden" data-action="document-input" data-document-type="carnet">
                                    <div id="carnetPlaceholderContent">
                                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                                        <p class="text-gray-600 font-semibold">Arrastra tu carnet aquí</p>
                                        <p class="text-sm text-gray-500 mt-1">o haz clic para seleccionar</p>
                                    </div>
                                    <div id="carnetPreviewContent" class="hidden">
                                        <i class="fas fa-file-image text-4xl text-blue-600 mb-3"></i>
                                        <p id="carnetFileName" class="font-semibold text-blue-600"></p>
                                        <p id="carnetFileSize" class="text-sm text-gray-500"></p>
                                        <button type="button" class="mt-2 text-red-600 hover:text-red-800 text-sm" data-action="remove-document" data-document-type="carnet">
                                            <i class="fas fa-trash mr-1"></i>Eliminar
                                        </button>
                                    </div>
                                </div>
                                <input type="hidden" id="carnetData">
                            </div>

                            <!-- Certificado de Antecedentes -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                    <i class="fas fa-certificate text-purple-600"></i>
                                    Certificado de Antecedentes *
                                </label>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-purple-400 transition" 
                                     id="uploadCertificadoZone" data-action="trigger-file-input" data-target-input="certificadoFileInput">
                                    <input type="file" id="certificadoFileInput" accept=".pdf,.jpg,.jpeg,.png" class="hidden" data-action="document-input" data-document-type="certificado">
                                    <div id="certificadoPlaceholderContent">
                                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                                        <p class="text-gray-600 font-semibold">Arrastra tu certificado aquí</p>
                                        <p class="text-sm text-gray-500 mt-1">o haz clic para seleccionar</p>
                                    </div>
                                    <div id="certificadoPreviewContent" class="hidden">
                                        <i class="fas fa-file-alt text-4xl text-purple-600 mb-3"></i>
                                        <p id="certificadoFileName" class="font-semibold text-purple-600"></p>
                                        <p id="certificadoFileSize" class="text-sm text-gray-500"></p>
                                        <button type="button" class="mt-2 text-red-600 hover:text-red-800 text-sm" data-action="remove-document" data-document-type="certificado">
                                            <i class="fas fa-trash mr-1"></i>Eliminar
                                        </button>
                                    </div>
                                </div>
                                <input type="hidden" id="certificadoData">
                            </div>

                            <!-- Poder de Cultivo (Cesión) -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                    <i class="fas fa-leaf text-teal-600"></i>
                                    Poder de Cultivo (Cesión de Derechos) *
                                </label>
                                <p class="text-xs text-gray-500 mb-3">
                                    Debes completar y generar el formulario de cesión de derechos de cultivo. Este documento es obligatorio según la Ley 20.000.
                                </p>
                                
                                <!-- Contenedor para el formulario de poder cultivo -->
                                <div id="poderCultivoContainerModal"></div>
                                
                                <input type="hidden" id="poderCultivoData">
                                <input type="hidden" id="poderCultivoFileName">
                                
                                <div id="poderCultivoStatusModal" class="hidden mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-check-circle text-green-600"></i>
                                        <span class="text-green-800 font-semibold text-sm">Documento de cesión generado correctamente</span>
                                    </div>
                                    <p id="poderCultivoFileNameDisplayModal" class="text-green-700 text-xs mt-1"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button type="button" class="admin-btn admin-btn--muted flex-1" data-action="close-add-user-modal">
                            Cancelar
                        </button>
                        <button type="submit" class="admin-btn admin-btn--primary flex-1">
                            <i class="fas fa-user-plus admin-btn__icon"></i>Crear Cliente
                        </button>
                    </div>
                </form>

                <!-- Formulario Administrador -->
                <form id="addAdminForm" class="user-form-tab hidden">
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <i class="fas fa-user-shield text-red-600"></i>
                                Información del Administrador
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Nombre Completo -->
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label>
                                    <div class="relative">
                                        <i class="fas fa-user absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                        <input type="text" id="adminName" required
                                               class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                               placeholder="Juan Pérez">
                                    </div>
                                </div>

                                <!-- Email -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Correo Electrónico *</label>
                                    <div class="relative">
                                        <i class="fas fa-envelope absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                        <input type="email" id="adminEmail" required
                                               class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                               placeholder="admin@apexremedy.local">
                                    </div>
                                </div>

                                <!-- Teléfono -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Teléfono (opcional)</label>
                                    <div class="relative">
                                        <i class="fas fa-phone absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                        <input type="tel" id="adminPhone"
                                               class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                               placeholder="+56912345678">
                                    </div>
                                </div>

                                <!-- Contraseña -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Contraseña *</label>
                                    <div class="relative">
                                        <i class="fas fa-lock absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                        <input type="password" id="adminPassword" required minlength="6"
                                               class="w-full pl-10 pr-10 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                               placeholder="••••••••">
                                        <button type="button" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600" 
                                                data-action="toggle-password-visibility" data-target-input="adminPassword" data-toggle-icon="toggleAdminPassword">
                                            <i id="toggleAdminPassword" class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Mínimo 6 caracteres</p>
                                </div>

                                <!-- Confirmar Contraseña -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Confirmar Contraseña *</label>
                                    <div class="relative">
                                        <i class="fas fa-lock absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                        <input type="password" id="adminConfirmPassword" required minlength="6"
                                               class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                               placeholder="••••••••">
                                    </div>
                                </div>
                            </div>

                            <!-- Info adicional -->
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mt-4">
                                <div class="flex items-start gap-3">
                                    <i class="fas fa-info-circle text-red-600 text-xl mt-1"></i>
                                    <div class="text-sm text-red-800">
                                        <p class="font-semibold mb-1">Nota sobre Administradores</p>
                                        <ul class="space-y-1">
                                            <li>• Los administradores tienen acceso completo al panel de administración</li>
                                            <li>• No requieren aprobación para iniciar sesión</li>
                                            <li>• Pueden gestionar productos, pedidos y usuarios</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button type="button" class="admin-btn admin-btn--muted flex-1" data-action="close-add-user-modal">
                            Cancelar
                        </button>
                        <button type="submit" class="admin-btn admin-btn--danger flex-1">
                            <i class="fas fa-user-shield admin-btn__icon"></i>Crear Administrador
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
            </div>
            <!-- End Manage Users Tab Content -->

            <!-- Roles and Permissions Tab Content -->
            <div id="content-rbac" class="users-tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Gestión de Roles y Permisos</h2>
                    <p class="text-gray-600">Administra los roles y permisos del sistema RBAC</p>
                </div>

                <!-- Roles Section -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800">
                            <i class="fas fa-user-shield mr-2 text-blue-600"></i>Roles del Sistema
                        </h3>
                        <button class="admin-btn admin-btn--accent admin-btn--compact" data-action="show-role-modal">
                            <i class="fas fa-plus admin-btn__icon"></i>Nuevo Rol
                        </button>
                    </div>
                    <div id="rolesListInUsers" class="space-y-4">
                        <div class="text-center py-8 text-gray-400">
                            <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                            <p>Cargando roles...</p>
                        </div>
                    </div>
                </div>

                <!-- Permissions Section -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800">
                            <i class="fas fa-key mr-2 text-purple-600"></i>Permisos del Sistema
                        </h3>
                        <button class="admin-btn admin-btn--accent admin-btn--compact" data-action="show-permission-modal">
                            <i class="fas fa-plus admin-btn__icon"></i>Nuevo Permiso
                        </button>
                    </div>
                    <div id="permissionsListInUsers" class="space-y-4">
                        <div class="text-center py-8 text-gray-400">
                            <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                            <p>Cargando permisos...</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Roles and Permissions Tab Content -->
        </div>
        <!-- End Tab Content Container -->

    <!-- Footer -->
    <div id="footer-container"></div>

    <!-- Scripts -->
    <script type="module" src="./js/adminTemplate.legacy.js"></script>
    <script src="./js/api/apiClient.js"></script>
    <script src="./js/auth.js"></script>
    <script src="./js/sessionManager.js"></script>
    <script src="./js/notifications.js"></script>
    <!-- Users page modules -->
    <script src="./js/users-main.js"></script>
    <script src="./js/users-modals.js"></script>
    <script src="./js/users-forms.js"></script>
    <script src="./js/users-rbac.js"></script>
    <script src="./js/users-utils.js"></script>
    <script src="./js/pages/users-page.js" defer></script>
    <!-- Note: Route protection (admin-only access) is handled in users-page.js -->

    <!-- Scripts de usuarios cargados desde archivos externos -->
    <!-- Todos los scripts inline han sido migrados a: -->
    <!-- - users-main.js: Funciones principales de usuarios -->
    <!-- - users-modals.js: Funciones de modales -->
    <!-- - users-forms.js: Funciones de formularios -->
    <!-- - users-rbac.js: Funciones de roles y permisos -->
    <!-- - users-utils.js: Utilidades y guía de aprobación -->

</body>
</html>
