<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Admin - Apexremedy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style/css_admin.css">
        <!-- env-config.js DEBE cargarse PRIMERO para sistema centralizado de rutas -->
    <script src="../js/env-config.js"></script>
<script src="./js/basePath.js"></script>
    <script src="./js/config.js"></script>
    <script src="./js/utils.js"></script>
    <script type="module" src="./js/adminTemplate.legacy.js"></script>
    <script defer src="./js/adminTemplate.js"></script>
</head>
<body>
    <!-- Header se carga autom√°ticamente -->
    <div id="header-container"></div>

    <!-- Formulario de Registro -->
    <div style="min-height: calc(100vh - 400px); display: flex; align-items: center; justify-content: center; padding: 60px 20px;">
        <div style="max-width: 600px; width: 100%;">
            <!-- Header -->
            <div style="text-align: center; margin-bottom: 32px;">
                <div style="width: 80px; height: 80px; margin: 0 auto 16px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-green), var(--light-green)); display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-user-plus" style="font-size: 2.5rem; color: var(--accent-yellow);"></i>
                </div>
                <h2 style="font-size: 2rem; font-weight: 800; color: var(--accent-black); margin-bottom: 8px;">
                    Crear Cuenta
                </h2>
                <p style="color: var(--medium-gray);">
                    √önete a la familia Apexremedy
                </p>
            </div>

            <!-- Formulario -->
            <div class="about-card">
                <form id="registerForm" style="display: flex; flex-direction: column; gap: 20px;">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Nombre -->
                        <div class="md:col-span-2">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--accent-black);">
                                Nombre Completo *
                            </label>
                            <div style="position: relative;">
                                <i class="fas fa-user" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--medium-gray);"></i>
                                <input type="text" 
                                       id="name" 
                                       name="name"
                                       required
                                       style="width: 100%; padding: 12px 12px 12px 40px; border: 2px solid var(--light-gray); border-radius: 8px; font-size: 1rem;"
                                       placeholder="Juan P√©rez">
                            </div>
                        </div>

                        <!-- Email -->
                        <div class="md:col-span-2">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--accent-black);">
                                Correo Electr√≥nico *
                            </label>
                            <div style="position: relative;">
                                <i class="fas fa-envelope" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--medium-gray);"></i>
                                <input type="email" 
                                       id="email" 
                                       name="email"
                                       required
                                       style="width: 100%; padding: 12px 12px 12px 40px; border: 2px solid var(--light-gray); border-radius: 8px; font-size: 1rem;"
                                       placeholder="tu@email.com">
                            </div>
                        </div>

                        <!-- Tel√©fono -->
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--accent-black);">
                                Tel√©fono *
                            </label>
                            <div style="position: relative;">
                                <i class="fas fa-phone" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--medium-gray);"></i>
                                <input type="tel" 
                                       id="phone" 
                                       name="phone"
                                       required
                                       style="width: 100%; padding: 12px 12px 12px 40px; border: 2px solid var(--light-gray); border-radius: 8px; font-size: 1rem;"
                                       placeholder="+56912345678">
                            </div>
                        </div>

                        <!-- RUT -->
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--accent-black);">
                                RUT
                            </label>
                            <div style="position: relative;">
                                <i class="fas fa-id-card" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--medium-gray);"></i>
                                <input type="text" 
                                       id="rut" 
                                       name="rut"
                                       onblur="formatRUTInput(this)"
                                       style="width: 100%; padding: 12px 12px 12px 40px; border: 2px solid var(--light-gray); border-radius: 8px; font-size: 1rem;"
                                       placeholder="12345678-9 o 12.345.678-9">
                            </div>
                            <p id="rutError" style="display: none; color: #dc2626; font-size: 0.85rem; margin-top: 4px;">
                                <i class="fas fa-exclamation-circle"></i> RUT inv√°lido
                            </p>
                        </div>

                        <!-- Password -->
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--accent-black);">
                                Contrase√±a *
                            </label>
                            <div style="position: relative;">
                                <i class="fas fa-lock" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--medium-gray);"></i>
                                <input type="password" 
                                       id="password" 
                                       name="password"
                                       required
                                       minlength="6"
                                       style="width: 100%; padding: 12px 40px 12px 40px; border: 2px solid var(--light-gray); border-radius: 8px; font-size: 1rem;"
                                       placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                <button type="button" 
                                        id="togglePassword"
                                        style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--medium-gray);">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <p style="font-size: 0.85rem; color: var(--medium-gray); margin-top: 4px;">
                                M√≠nimo 6 caracteres
                            </p>
                        </div>

                        <!-- Confirmar Password -->
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--accent-black);">
                                Confirmar Contrase√±a *
                            </label>
                            <div style="position: relative;">
                                <i class="fas fa-lock" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--medium-gray);"></i>
                                <input type="password" 
                                       id="confirmPassword" 
                                       name="confirmPassword"
                                       required
                                       minlength="6"
                                       style="width: 100%; padding: 12px 40px 12px 40px; border: 2px solid var(--light-gray); border-radius: 8px; font-size: 1rem;"
                                       placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            </div>
                        </div>
                    </div>

                    <!-- Direcci√≥n (Opcional) -->
                    <div id="addressSection" style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e5e7eb; display: block;">
                        <h4 style="font-size: 1.1rem; font-weight: 700; color: #1f2937; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-map-marker-alt" style="color: #10b981;"></i>
                            Direcci√≥n de Entrega (Opcional)
                        </h4>
                        <p style="font-size: 0.9rem; color: #6b7280; margin-bottom: 16px;">
                            Puedes agregarla ahora o m√°s tarde en el proceso de compra
                        </p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Calle y n√∫mero -->
                            <div class="md:col-span-2">
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--accent-black);">
                                    Calle y n√∫mero
                                </label>
                                <div style="position: relative;">
                                    <i class="fas fa-home" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--medium-gray);"></i>
                                    <input type="text" 
                                           id="addressLine1" 
                                           name="addressLine1"
                                           style="width: 100%; padding: 12px 12px 12px 40px; border: 2px solid var(--light-gray); border-radius: 8px; font-size: 1rem;"
                                           placeholder="Calle y n√∫mero">
                                </div>
                            </div>
                            
                            <!-- Tipo de direcci√≥n (Depto/Casa/Oficina) -->
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--accent-black);">
                                    Tipo (opcional)
                                </label>
                                <div style="position: relative;">
                                    <i class="fas fa-building" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--medium-gray); z-index: 1;"></i>
                                    <select id="addressType" 
                                            name="addressType"
                                            style="width: 100%; padding: 12px 12px 12px 40px; border: 2px solid var(--light-gray); border-radius: 8px; font-size: 1rem; appearance: none; background-color: white; cursor: pointer;">
                                        <option value="">Tipo (opcional)</option>
                                        <option value="Depto">Depto</option>
                                        <option value="Casa">Casa</option>
                                        <option value="Oficina">Oficina</option>
                                    </select>
                                    <i class="fas fa-chevron-down" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--medium-gray); pointer-events: none;"></i>
                                </div>
                            </div>
                            
                            <!-- Referencia (texto aparte) -->
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--accent-black);">
                                    Referencia (opcional)
                                </label>
                                <div style="position: relative;">
                                    <i class="fas fa-info-circle" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--medium-gray);"></i>
                                    <input type="text" 
                                           id="addressReference" 
                                           name="addressReference"
                                           style="width: 100%; padding: 12px 12px 12px 40px; border: 2px solid var(--light-gray); border-radius: 8px; font-size: 1rem;"
                                           placeholder="Ej: Frente a plaza">
                                </div>
                            </div>
                            
                            <!-- Regi√≥n -->
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--accent-black);">
                                    Regi√≥n
                                </label>
                                <div style="position: relative;">
                                    <i class="fas fa-globe-americas" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--medium-gray); z-index: 1;"></i>
                                    <select id="region" 
                                            name="region"
                                            onchange="loadCitiesForRegion()"
                                            style="width: 100%; padding: 12px 12px 12px 40px; border: 2px solid var(--light-gray); border-radius: 8px; font-size: 1rem; appearance: none; background-color: white; cursor: pointer;">
                                        <option value="">Selecciona una regi√≥n</option>
                                    </select>
                                    <i class="fas fa-chevron-down" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--medium-gray); pointer-events: none;"></i>
                                </div>
                            </div>
                            
                            <!-- Ciudad -->
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--accent-black);">
                                    Ciudad
                                </label>
                                <div style="position: relative;">
                                    <i class="fas fa-city" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--medium-gray); z-index: 1;"></i>
                                    <select id="city" 
                                            name="city"
                                            onchange="loadCommunesForCity()"
                                            disabled
                                            style="width: 100%; padding: 12px 12px 12px 40px; border: 2px solid var(--light-gray); border-radius: 8px; font-size: 1rem; appearance: none; background-color: #f5f5f5; cursor: not-allowed; color: #999;">
                                        <option value="">Primero selecciona una regi√≥n</option>
                                    </select>
                                    <i class="fas fa-chevron-down" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--medium-gray); pointer-events: none;"></i>
                                </div>
                            </div>
                            
                            <!-- Comuna -->
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--accent-black);">
                                    Comuna
                                </label>
                                <div style="position: relative;">
                                    <i class="fas fa-map-pin" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--medium-gray); z-index: 1;"></i>
                                    <select id="commune" 
                                            name="commune"
                                            disabled
                                            style="width: 100%; padding: 12px 12px 12px 40px; border: 2px solid var(--light-gray); border-radius: 8px; font-size: 1rem; appearance: none; background-color: #f5f5f5; cursor: not-allowed; color: #999;">
                                        <option value="">Primero selecciona una ciudad</option>
                                    </select>
                                    <i class="fas fa-chevron-down" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--medium-gray); pointer-events: none;"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- T√©rminos -->
                    <div>
                        <label style="display: flex; align-items: start; cursor: pointer;">
                            <input type="checkbox" 
                                   id="terms"
                                   required
                                   style="margin-right: 8px; margin-top: 4px; width: 18px; height: 18px;">
                            <span style="font-size: 0.95rem; color: var(--accent-black);">
                                Acepto los <a href="#" style="color: var(--primary-green); font-weight: 600;">t√©rminos y condiciones</a> y la <a href="#" style="color: var(--primary-green); font-weight: 600;">pol√≠tica de privacidad</a>
                            </span>
                        </label>
                    </div>

                    <!-- Mensajes -->
                    <div id="messageContainer" style="display: none;">
                        <div id="errorMessage" style="display: none; background: #fee; border: 1px solid #fcc; color: #c00; padding: 12px; border-radius: 8px;">
                            <i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i>
                            <span id="errorText"></span>
                        </div>
                        <div id="successMessage" style="display: none; background: #efe; border: 1px solid #cfc; color: #060; padding: 12px; border-radius: 8px;">
                            <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
                            <span id="successText"></span>
                        </div>
                    </div>

                    <!-- Bot√≥n Submit -->
                    <button type="submit" 
                            id="submitBtn"
                            class="cta-button full-width"
                            style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span id="btnText">Crear Cuenta</span>
                        <i id="btnLoader" style="display: none;" class="fas fa-spinner fa-spin"></i>
                    </button>
                </form>

                <!-- Login -->
                <div style="margin-top: 24px; text-align: center; padding-top: 24px; border-top: 1px solid var(--light-gray);">
                    <p style="color: var(--medium-gray);">
                        ¬øYa tienes cuenta? 
                        <a href="./login.html" style="color: var(--primary-green); font-weight: 600; text-decoration: none;">
                            Inicia Sesi√≥n
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer-container"></div>

    <!-- Scripts -->
    <script src="./js/api/apiClient.js"></script>
    <script src="./js/auth.js"></script>
    <script src="./js/sessionManager.js"></script>
    <script src="./js/notifications.js"></script>
    <script>
        // Toggle password visibility
        document.getElementById('togglePassword').addEventListener('click', function() {
            const passwordInput = document.getElementById('password');
            const icon = this.querySelector('i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });

        // Manejar submit del formulario
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const btnLoader = document.getElementById('btnLoader');
            
            // Obtener datos del formulario
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const rut = document.getElementById('rut').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validaci√≥n b√°sica
            if (!name || !email || !password || !phone) {
                showError('Por favor completa todos los campos obligatorios (nombre, email, tel√©fono y contrase√±a)');
                if (!phone) {
                    document.getElementById('phone').focus();
                }
                return;
            }
            
            // Dividir nombre en first_name y last_name
            const nameParts = name.split(' ').filter(part => part.trim() !== '');
            const first_name = nameParts[0] || name;
            const last_name = nameParts.slice(1).join(' ') || first_name;
            
            // Validar email
            if (!Utils.isValidEmail(email)) {
                showError('Por favor ingresa un correo electr√≥nico v√°lido');
                document.getElementById('email').focus();
                return;
            }
            
            // Validar RUT si se ingres√≥
            if (rut && !Utils.isValidRUT(rut)) {
                showError('Por favor ingresa un RUT v√°lido (formato: 12345678-9)');
                document.getElementById('rut').focus();
                document.getElementById('rutError').style.display = 'block';
                return;
            } else {
                document.getElementById('rutError').style.display = 'none';
            }
            
            if (password.length < 6) {
                showError('La contrase√±a debe tener al menos 6 caracteres');
                return;
            }
            
            if (password !== confirmPassword) {
                showError('Las contrase√±as no coinciden');
                return;
            }
            
            // Deshabilitar bot√≥n y mostrar loader
            submitBtn.disabled = true;
            btnText.textContent = 'Creando cuenta...';
            btnLoader.style.display = 'inline-block';
            hideMessages();
            
            try {
                // Preparar datos (incluir direcci√≥n si se complet√≥)
                const addressLine1 = document.getElementById('addressLine1').value.trim();
                const addressType = document.getElementById('addressType').value;
                const addressReference = document.getElementById('addressReference').value.trim();
                // Combinar tipo y referencia en addressLine2 si existe alguno
                let addressLine2 = '';
                if (addressType && addressReference) {
                    addressLine2 = `${addressType} ${addressReference}`;
                } else if (addressType) {
                    addressLine2 = addressType;
                } else if (addressReference) {
                    addressLine2 = addressReference;
                }
                
                const regionSelect = document.getElementById('region');
                const citySelect = document.getElementById('city');
                const communeSelect = document.getElementById('commune');
                const region = regionSelect.value;
                const city = citySelect.value;
                const commune = communeSelect.value;
                
                const userData = {
                    email,
                    password,
                    first_name,
                    last_name,
                    phone: phone,
                    rut: rut || undefined,
                    // Direcci√≥n solo si se complet√≥ al menos regi√≥n, ciudad y comuna
                    ...(region && city && commune ? {
                        addressLine1: addressLine1 || undefined,
                        addressLine2: addressLine2 || undefined,
                        region: regionSelect.options[regionSelect.selectedIndex]?.textContent || undefined,
                        city: citySelect.options[citySelect.selectedIndex]?.textContent || undefined,
                        commune: commune || undefined
                    } : {})
                };
                
                // Intentar registro
                const result = await authManager.register(userData);
                
                if (result.success) {
                    // √âxito
                    showSuccess('¬°Cuenta creada exitosamente! Redirigiendo...');
                    
                    // Esperar un momento y redirigir
                    setTimeout(() => {
                        window.location.href = './index.html';
                    }, 1500);
                } else {
                    // Manejar errores espec√≠ficos con mensajes personalizados
                    const errorCode = result.error_code;
                    const field = result.field;
                    let errorMessage = result.message || 'Error al crear la cuenta';
                    
                    // Mensajes personalizados seg√∫n el c√≥digo de error
                    if (errorCode === 'EMAIL_ALREADY_EXISTS') {
                        errorMessage = result.message || 'Este correo electr√≥nico ya est√° registrado. Si ya tienes una cuenta, intenta iniciar sesi√≥n.';
                        const emailInput = document.getElementById('email');
                        if (emailInput) {
                            emailInput.style.borderColor = '#dc2626';
                            emailInput.focus();
                        }
                    } else if (errorCode === 'RUT_ALREADY_EXISTS') {
                        errorMessage = result.message || 'Este RUT ya est√° registrado. Cada persona solo puede tener una cuenta.';
                        const rutInput = document.getElementById('rut');
                        if (rutInput) {
                            rutInput.style.borderColor = '#dc2626';
                            rutInput.focus();
                        }
                    } else if (errorCode === 'INVALID_RUT') {
                        errorMessage = result.message || 'El RUT ingresado no es v√°lido. Verifica el formato y el d√≠gito verificador.';
                        const rutInput = document.getElementById('rut');
                        if (rutInput) {
                            rutInput.style.borderColor = '#dc2626';
                            document.getElementById('rutError').style.display = 'block';
                            rutInput.focus();
                        }
                    } else if (errorCode === 'INVALID_EMAIL_FORMAT') {
                        errorMessage = result.message || 'El formato del correo electr√≥nico no es v√°lido.';
                        const emailInput = document.getElementById('email');
                        if (emailInput) {
                            emailInput.style.borderColor = '#dc2626';
                            emailInput.focus();
                        }
                    }
                    
                    // Error
                    showError(errorMessage);
                    resetButton();
                }
            } catch (error) {
                console.error('Error en registro:', error);
                let errorMessage = 'Error al conectar con el servidor';
                
                // Si el error tiene un mensaje del backend
                if (error.response && error.response.data && error.response.data.message) {
                    errorMessage = error.response.data.message;
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showError(errorMessage);
                resetButton();
            }
        });
        
        // Funciones auxiliares
        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            const messageContainer = document.getElementById('messageContainer');
            
            errorText.textContent = message;
            errorMessage.style.display = 'block';
            messageContainer.style.display = 'block';
            
            // Scroll al mensaje
            errorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        function showSuccess(message) {
            const successMessage = document.getElementById('successMessage');
            const successText = document.getElementById('successText');
            const messageContainer = document.getElementById('messageContainer');
            
            successText.textContent = message;
            successMessage.style.display = 'block';
            messageContainer.style.display = 'block';
        }
        
        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }
        
        function resetButton() {
            const submitBtn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const btnLoader = document.getElementById('btnLoader');
            
            submitBtn.disabled = false;
            btnText.textContent = 'Crear Cuenta';
            btnLoader.style.display = 'none';
        }
        
        // Formatear RUT al perder el foco
        function formatRUTInput(input) {
            const rutValue = input.value.trim();
            if (rutValue && Utils.isValidRUT(rutValue)) {
                input.value = Utils.formatRUT(rutValue);
                document.getElementById('rutError').style.display = 'none';
            } else if (rutValue) {
                document.getElementById('rutError').style.display = 'block';
            }
        }

        // Cargar datos de regiones, ciudades y comunas
        let chileLocations = null;
        
        async function loadChileLocations() {
            try {
                // Intentar cargar desde diferentes rutas posibles
                const paths = [
                    '../data/chile-locations.json',
                    './data/chile-locations.json',
                    '../../data/chile-locations.json',
                    '/frontend/data/chile-locations.json',
                    '/data/chile-locations.json'
                ];
                
                let response = null;
                let lastError = null;
                
                for (const path of paths) {
                    try {
                        console.log(`üìÇ Intentando cargar desde: ${path}`);
                        response = await fetch(path);
                        if (response.ok) {
                            console.log(`‚úÖ Archivo encontrado en: ${path}`);
                            break;
                        }
                    } catch (err) {
                        lastError = err;
                        continue;
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error(`No se pudo cargar datos de ubicaciones. √öltimo error: ${lastError?.message || 'Archivo no encontrado'}`);
                }
                
                chileLocations = await response.json();
                
                if (!chileLocations || !chileLocations.regions || chileLocations.regions.length === 0) {
                    throw new Error('El archivo JSON no contiene datos v√°lidos');
                }
                
                populateRegions();
                console.log(`‚úÖ Ubicaciones de Chile cargadas correctamente: ${chileLocations.regions.length} regiones`);
            } catch (error) {
                console.error('‚ö†Ô∏è Error cargando ubicaciones:', error);
                // Crear estructura b√°sica si falla
                chileLocations = { regions: [] };
                console.warn('‚ö†Ô∏è Usando estructura vac√≠a de ubicaciones');
                
                // Mostrar mensaje al usuario
                const addressSection = document.getElementById('addressSection');
                if (addressSection) {
                    const errorMsg = document.createElement('p');
                    errorMsg.style.cssText = 'color: #ef4444; font-size: 0.85rem; margin-top: 8px;';
                    errorMsg.textContent = '‚ö†Ô∏è No se pudieron cargar las ubicaciones. Por favor, ingresa la direcci√≥n manualmente.';
                    addressSection.appendChild(errorMsg);
                }
            }
        }
        
        function populateRegions() {
            const regionSelect = document.getElementById('region');
            regionSelect.innerHTML = '<option value="">Selecciona una regi√≥n</option>';
            
            if (chileLocations && chileLocations.regions) {
                chileLocations.regions.forEach(region => {
                    const option = document.createElement('option');
                    option.value = region.id;
                    option.textContent = region.name;
                    option.dataset.regionData = JSON.stringify(region);
                    regionSelect.appendChild(option);
                });
            }
        }
        
        function loadCitiesForRegion() {
            const regionSelect = document.getElementById('region');
            const citySelect = document.getElementById('city');
            const communeSelect = document.getElementById('commune');
            
            const selectedRegionId = regionSelect.value;
            
            // Resetear ciudades y comunas
            citySelect.innerHTML = '<option value="">Selecciona una ciudad</option>';
            communeSelect.innerHTML = '<option value="">Primero selecciona una ciudad</option>';
            communeSelect.disabled = true;
            
            if (!selectedRegionId) {
                citySelect.disabled = true;
                citySelect.style.backgroundColor = '#f5f5f5';
                citySelect.style.color = '#999';
                citySelect.style.cursor = 'not-allowed';
                return;
            }
            
            // Habilitar selector de ciudad
            citySelect.disabled = false;
            citySelect.style.backgroundColor = 'white';
            citySelect.style.color = 'inherit';
            citySelect.style.cursor = 'pointer';
            
            // Obtener regi√≥n seleccionada
            const selectedOption = regionSelect.options[regionSelect.selectedIndex];
            const regionData = JSON.parse(selectedOption.dataset.regionData || '{}');
            
            if (regionData.cities && regionData.cities.length > 0) {
                regionData.cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.id;
                    option.textContent = city.name;
                    option.dataset.cityData = JSON.stringify(city);
                    citySelect.appendChild(option);
                });
            }
        }
        
        function loadCommunesForCity() {
            const regionSelect = document.getElementById('region');
            const citySelect = document.getElementById('city');
            const communeSelect = document.getElementById('commune');
            
            const selectedCityId = citySelect.value;
            
            // Resetear comunas
            communeSelect.innerHTML = '<option value="">Selecciona una comuna</option>';
            
            if (!selectedCityId) {
                communeSelect.disabled = true;
                communeSelect.style.backgroundColor = '#f5f5f5';
                communeSelect.style.color = '#999';
                communeSelect.style.cursor = 'not-allowed';
                return;
            }
            
            // Habilitar selector de comuna
            communeSelect.disabled = false;
            communeSelect.style.backgroundColor = 'white';
            communeSelect.style.color = 'inherit';
            communeSelect.style.cursor = 'pointer';
            
            // Obtener ciudad seleccionada
            const selectedOption = citySelect.options[citySelect.selectedIndex];
            const cityData = JSON.parse(selectedOption.dataset.cityData || '{}');
            
            if (cityData.communes && cityData.communes.length > 0) {
                cityData.communes.forEach(commune => {
                    const option = document.createElement('option');
                    option.value = commune;
                    option.textContent = commune;
                    communeSelect.appendChild(option);
                });
            }
        }
        
        // Redirigir si ya est√° autenticado y cargar ubicaciones
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (typeof authManager !== 'undefined' && authManager.isAuthenticated()) {
                    window.location.href = './index.html';
                }
            }, 100);
            
            // Cargar ubicaciones de Chile
            console.log('üìç Cargando ubicaciones de Chile...');
            loadChileLocations();
            
            // Verificar que los elementos existan
            setTimeout(() => {
                const regionSelect = document.getElementById('region');
                const citySelect = document.getElementById('city');
                const communeSelect = document.getElementById('commune');
                const addressSection = document.getElementById('addressSection');
                
                console.log('üîç Verificando elementos:', {
                    regionSelect: !!regionSelect,
                    citySelect: !!citySelect,
                    communeSelect: !!communeSelect,
                    addressSection: !!addressSection,
                    addressSectionVisible: addressSection ? window.getComputedStyle(addressSection).display : 'N/A'
                });
                
                if (!regionSelect || !citySelect || !communeSelect) {
                    console.error('‚ùå Faltan elementos del formulario de direcci√≥n');
                } else {
                    console.log('‚úÖ Todos los elementos de direcci√≥n est√°n presentes');
                }
            }, 500);
        });
    </script>
</body>
</html>