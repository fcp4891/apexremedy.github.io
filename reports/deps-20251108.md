# Inventario Front/Admin (08-11-2025)

## Resumen de stack
- **Entorno:** HTML estático servido desde `frontend/admin`, sin bundler (uso directo de `<script>` y `<link>`).
- **CSS global:** `style/css_admin.css` concentra variables, reset parcial y la mayoría de componentes reusables.
- **CSS por vista:** archivos específicos (`index.css`, `dashboard.css`, `orders.css`, etc.) mezclan reglas de página con estilos comunes.
- **JS compartido:** patrón global IIFE + `window.*`. No existe `src/lib` o `src/views`; los módulos viven en `frontend/admin/js`.

## Mapa de dependencias (HTML → CSS/JS)

| Vista | CSS cargado | JS cargado (orden declarativo) |
| --- | --- | --- |
| `index.html` | `css_admin.css`, `index.css` | `basePath`, `config`, `utils`, `adminTemplate`, `api/apiClient`, `auth`, `sessionManager`, `notifications`, inline bootstrap |
| `dashboard.html` | `css_admin.css`, `dashboard.css` | `Chart.js`, `ECharts`, `basePath`, `config`, `utils`, `api/apiClient`, `auth`, `sessionManager`, `notifications`, `adminTemplate`, `dashboard-complete`, inline data patches |
| `users.html` | `css_admin.css`, `users.css` | `basePath`, `config`, `utils`, `adminTemplate`, `api/apiClient`, `auth`, `sessionManager`, `notifications`, inline render helpers |
| `products.html` | `css_admin.css`, `products.css`, `products-modal-enhanced.css` | `basePath`, `config`, `utils`, `adminTemplate`, `api/apiClient`, `auth`, `sessionManager`, `notifications`, `adminProductModals`, `adminEditModals`, inline dataset |
| `orders.html` | `css_admin.css`, `orders.css` | `basePath`, `config`, `utils`, `adminTemplate`, `api/apiClient`, `auth`, `sessionManager`, `notifications`, inline tabla, **duplicado** `../js/api/apiClient.js` |
| `payments.html` | `css_admin.css`, `payments.css` | `basePath`, `config`, `utils`, `notifications`, `auth`, `api/apiClient`, `adminTemplate`, `payments`, `paymentsCRUD` |
| `perfil.html` | `css_admin.css`, `perfil.css` | `basePath`, `config`, `utils`, `adminTemplate`, `api/apiClient`, `auth`, `notifications`, inline UI |
| `registro.html` | `css_admin.css` | `basePath`, `config`, `utils`, `adminTemplate`, `api/apiClient`, `auth`, `sessionManager`, `notifications`, inline wizard |
| `dispensary.html` | `css_admin.css` | `basePath`, `config`, `utils`, `adminTemplate`, `SignaturePad`, `dispensaryManager` |
| `carrito.html` / `checkout.html` | `css_admin.css` | `basePath`, `config`, `utils`, `adminTemplate`, `api/apiClient`, `auth`, `sessionManager`, `notifications`, inline |
| Familia logística (`logistica*.html`) | `css_admin.css` | `basePath`, `config`, `utils`, `api/apiClient`, `auth`, `notifications`, `adminTemplate`, `chileRegions` (solo `logistica-zonas.html`), inline catálogos |
| `orders.html` (observación) | — | segunda carga del `apiClient` con ruta relativa distinta (`../js/...`) → candidata a limpieza |
| `test-payment-dashboard.html` | `css_admin.css` (implícito via CDN) | `echarts`, `basePath`, `config`, `api/apiClient`, inline mock |

**Notas:**
- `tailwindcss` y `font-awesome` se incluyen vía CDN en todas las vistas → considerar consolidar en layout y evaluar uso real para purge/safelist.
- La mayoría de vistas cargan los mismos 8 scripts básicos (`basePath`, `config`, `utils`, `api/apiClient`, `auth`, `sessionManager`, `notifications`, `adminTemplate`), pero no existe módulo compartido para agruparlos.

## Dependencias JS internas

- `basePath.js` define `window.BASE_PATH`, usado por `adminTemplate` y helpers de redirección.
- `config.js` expone `window.CONFIG` (tokens, rutas de recursos, defaults) consumido por `utils`, `dispensaryManager`, `payments`, etc.
- `utils.js` declara `window.Utils` (formateos, toasts, confirmaciones). Consumido directamente desde plantillas HTML e inline scripts.
- `api/apiClient.js` crea `window.api`; depende de `authManager` para logout en expiración. Invocado por `auth.js`, `dispensaryManager.js`, `payments*.js`, vistas inline.
- `auth.js` define `window.authManager` y despacha eventos `userLoggedIn/userLoggedOut`; usa `api` y `Utils`.
- `sessionManager.js` subscribe a eventos de `authManager`; manipula `localStorage` y timers.
- `notifications.js` crea `window.notify`; usado por `adminTemplate` y vistas (`orders`, `products`, etc.).
- `adminTemplate.js` depende de `authManager`, `notify`, `BASE_PATH`; inyecta header/footer, controla sidebar y expone API global `window.adminTemplate`.
- Scripts específicos (`payments.js`, `paymentsCRUD.js`, `dashboard-complete.js`, `dispensaryManager.js`, `adminProductModals.js`, `adminEditModals.js`) consumen `api`, `Utils`, `notify` y elementos DOM sin patrón modular.

### Patrón de eventos
- Eventos personalizados: `userLoggedIn`, `userLoggedOut`, `orderUpdated` (en `orders.html` inline), sin canal centralizado.
- Listeners duplicados detectados en inline scripts de `orders.html` y `users.html`.

## Uso real de selectores CSS (muestreo inicial)

| Selector | Definición | Coincidencias reales (`rg`) | Observaciones |
| --- | --- | --- | --- |
| `.admin-stat-card` | `style/css_admin.css` | 8 (CSS) + 4 (HTML) | Usado solo en `index.html`. Mantener en componente o mover a `components.css`. |
| `.admin-sidebar` | `style/css_admin.css` | 6 (CSS) + 5 (componentes/header.html) | Exclusivo del layout cargado dinámicamente. Necesario. |
| `.admin-quick-action` | `style/index.css` | 12 (`index.html`) | Restricto a vista `index`. Buen candidato a `views/home/home.css`. |
| `.admin-table` | `style/orders.css` | 15 (`orders.html`) | También referenciado en `users.html` → revisar duplicidad entre `orders.css` y `users.css`. |
| `.status-badge` | `style/orders.css` + inline | 10 (`orders.html`, `users.html`) | Reglas duplicadas en `orders.css` y `users.css`. Consolidar. |
| `.modal` prefijo | `style/products-modal-enhanced.css` | 23 (`products.html`, `components/modals*.html`) | Reglas se solapan con `adminProductModals.js` → evaluar mover a `components`. |

> Próximo paso: correr análisis completo con script para mapear todos los selectores (`postcss-selector-parser` + `rg`). Tiempo estimado: 1h.

## Áreas de deuda detectada
- **Globales mezclados:** `css_admin.css` contiene reset, layout, componentes, utilidades y overrides responsivos en un solo archivo (~1500 líneas).
- **Duplicados:** lógica de modales (`adminProductModals.js` vs `adminEditModals.js`), listeners form duplicados en cada HTML.
- **Dependencias CDN:** `tailwindcss` se usa para utilidades, pero existe CSS personalizado que imita un diseño propio → evaluar migración a utility-first real o reducir dependencias.
- **Rutas relativas inconsistentes:** mezcla de `./`, `../` y rutas absolutas en scripts/links; provoca bugs en GitHub Pages.
- **Eventos:** No hay capa central para broadcasting; cada vista declara `DOMContentLoaded` y listeners propios.

## Recomendaciones iniciales (para RFC)
- Definir estructura destino `frontend/src/` con `styles/{base,utilities,components}.css` y `views/{vista}/{vista}.{html,css,js}`.
- Centralizar bootstrap en `frontend/admin/index-admin.html` (template) o empaquetar con herramienta ligera (Vite) sin cambiar contratos.
- Implementar `src/lib/notifications.js`, `src/lib/logger.js`, `src/lib/apiClient.js` (envolviendo actual globales).
- Planificar purga de CSS tras mover clases a estructura BEM/utility-first (definir convención).
- Levantar `CHANGES.md` y `RFC-REFactor-20251108.md` con detalle antes de tocar código.




